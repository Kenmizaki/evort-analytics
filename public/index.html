<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>evort Analytics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd', 400: '#a78bfa',
              500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95',
            }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Noto Sans JP', sans-serif; background: #f8f7fc; }
    .sidebar-fixed { width: 280px; min-width: 280px; }
    @media (max-width: 1024px) { .sidebar-fixed { display: none; } }
    .loading-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    .live-dot { animation: live-pulse 2s ease-in-out infinite; }
    @keyframes live-pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.2); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ========== API Client ==========
    const API_BASE = '/api/ga4-report';

    async function fetchGA4(params = {}) {
      const queryString = new URLSearchParams(params).toString();
      const url = `${API_BASE}?${queryString}`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error('API fetch error:', error);
        throw error;
      }
    }

    // ========== ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆæœŸè¡¨ç¤ºç”¨ï¼‰ ==========
    const emptyDailyData = [{ date: '-', pv: 0, sessions: 0 }];
    const emptyRegions = [];
    const emptyDevices = [{ name: 'PC', value: 0, color: '#8b5cf6' }, { name: 'Mobile', value: 0, color: '#22c55e' }, { name: 'Tablet', value: 0, color: '#94a3b8' }];

    // ========== 4ã¤ã®URLã‚«ãƒ†ã‚´ãƒª ==========
    const URL_CATEGORIES = [
      { id: 'company-content', label: 'ä¼æ¥­ã‚³ãƒ³ãƒ†ãƒ³ãƒ„', color: 'blue', description: 'ä¼æ¥­ç´¹ä»‹ã€è£½å“ãƒšãƒ¼ã‚¸ãªã©' },
      { id: 'media-content', label: 'é›†å®¢ç”¨è¨˜äº‹', color: 'green', description: 'ãƒ–ãƒ­ã‚°ã€SEOè¨˜äº‹ãªã©' },
      { id: 'form-content', label: 'ãƒ•ã‚©ãƒ¼ãƒ ', color: 'purple', description: 'å•ã„åˆã‚ã›ã€è³‡æ–™è«‹æ±‚ãªã©' },
      { id: 'exclude-content', label: 'é™¤å¤–URL', color: 'red', description: 'è¨ˆæ¸¬ã‹ã‚‰é™¤å¤–ã™ã‚‹URL' },
    ];

    // ========== ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç† ==========
    const STORAGE_KEY = 'evort_analytics_projects';

    function loadProjects() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
      } catch { return []; }
    }

    function saveProjects(projects) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
    }

    // ========== å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ==========

    // æŒ‡æ¨™ã‚«ãƒ¼ãƒ‰
    function MetricCard({ title, value, suffix = '', loading = false }) {
      if (loading) return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
          <div className="h-4 w-16 bg-gray-200 rounded loading-pulse mb-2"></div>
          <div className="h-8 w-24 bg-gray-200 rounded loading-pulse"></div>
        </div>
      );
      return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
          <div className="text-gray-500 text-xs mb-1">{title}</div>
          <div className="text-2xl font-bold text-gray-800">
            {typeof value === 'number' ? value.toLocaleString() : value}
            {suffix && <span className="text-base font-normal text-gray-500 ml-1">{suffix}</span>}
          </div>
        </div>
      );
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒŠãƒ¼
    function RealtimeBanner({ data, loading }) {
      if (loading) return (
        <div className="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-4 mb-5 text-white">
          <div className="flex items-center gap-2 loading-pulse">
            <div className="w-3 h-3 bg-white rounded-full"></div>
            <span className="text-sm">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èª­ã¿è¾¼ã¿ä¸­...</span>
          </div>
        </div>
      );
      return (
        <div className="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-4 mb-5 text-white">
          <div className="flex items-center gap-3">
            <div className="w-3 h-3 bg-white rounded-full live-dot"></div>
            <span className="text-sm font-medium">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </span>
            <span className="text-3xl font-bold">{data?.totalActiveUsers || 0}</span>
            <span className="text-green-100">äººãŒã‚¢ã‚¯ã‚»ã‚¹ä¸­</span>
          </div>
        </div>
      );
    }

    // æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆGA4ã‹ã‚‰å–å¾—ã—ãŸæ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
    function TrendChart({ data, loading, dateRange }) {
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      // æœˆåˆ¥ã«é›†ç´„ã™ã‚‹é–¢æ•°
      const aggregateByMonth = (dailyData) => {
        const monthMap = new Map();
        dailyData.forEach(d => {
          const monthKey = d.date.substring(0, 7); // "01/15" â†’ "01"ã¾ãŸã¯"2024-01" â†’ "2024-01"
          // GA4ã®æ—¥ä»˜å½¢å¼ãŒ"YYYYMMDD"ã®å ´åˆ
          const dateStr = d.date.replace(/\//g, '');
          const month = dateStr.length === 8 ? dateStr.substring(0, 6) : d.date.substring(0, 7);
          if (!monthMap.has(month)) {
            monthMap.set(month, { pv: 0, sessions: 0 });
          }
          const m = monthMap.get(month);
          m.pv += d.pv || 0;
          m.sessions += d.sessions || 0;
        });
        return Array.from(monthMap.entries())
          .sort((a, b) => a[0].localeCompare(b[0]))
          .map(([month, values]) => ({
            date: month.length === 6 ? `${month.substring(4, 6)}æœˆ` : month,
            pv: values.pv,
            sessions: values.sessions
          }));
      };

      // 90æ—¥ä»¥ä¸Šï¼ˆ365daysAgoã¾ãŸã¯90daysAgoï¼‰ã®å ´åˆã¯æœˆåˆ¥è¡¨ç¤º
      const shouldAggregateByMonth = dateRange === '365daysAgo' || dateRange === '90daysAgo';
      const chartData = shouldAggregateByMonth && data?.length > 60 ? aggregateByMonth(data) : data;

      useEffect(() => {
        if (chartInstance.current) chartInstance.current.destroy();
        if (!chartData || chartData.length === 0) return;
        if (!chartRef.current) return;

        const ctx = chartRef.current.getContext('2d');
        const pvGradient = ctx.createLinearGradient(0, 0, 0, 220);
        pvGradient.addColorStop(0, 'rgba(99, 102, 241, 0.9)');
        pvGradient.addColorStop(0.5, 'rgba(59, 130, 246, 0.7)');
        pvGradient.addColorStop(1, 'rgba(34, 197, 94, 0.6)');

        chartInstance.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: chartData.map(d => d.date),
            datasets: [{
              label: 'PV', data: chartData.map(d => d.pv), fill: true, backgroundColor: pvGradient,
              borderColor: 'rgba(99, 102, 241, 0.8)', borderWidth: 2, tension: 0.4, pointRadius: shouldAggregateByMonth ? 4 : 0,
              yAxisID: 'y', order: 2
            }, {
              label: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³', data: chartData.map(d => d.sessions), fill: false, borderColor: '#f97316',
              borderWidth: 2, tension: 0.3, pointRadius: shouldAggregateByMonth ? 4 : 3, yAxisID: 'y1', order: 1
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
            scales: {
              y: { type: 'linear', display: true, position: 'left', grid: { color: '#f1f5f9' }, beginAtZero: true },
              y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, beginAtZero: true },
              x: { grid: { display: false } }
            },
            plugins: { legend: { position: 'top', labels: { font: { size: 11 }, usePointStyle: true } } }
          }
        });
        return () => { if (chartInstance.current) chartInstance.current.destroy(); };
      }, [chartData, loading, dateRange]);

      if (loading) {
        return (
          <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
            <h3 className="text-sm font-medium text-gray-700 mb-4">æ¨ç§»</h3>
            <div style={{ height: '220px' }} className="flex items-center justify-center">
              <span className="text-gray-400 loading-pulse">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
          </div>
        );
      }

      return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
          <h3 className="text-sm font-medium text-gray-700 mb-4">æ¨ç§»ï¼ˆGA4ãƒ‡ãƒ¼ã‚¿ï¼‰</h3>
          <div style={{ height: '220px' }}><canvas ref={chartRef}></canvas></div>
        </div>
      );
    }

    // åœ°åŸŸåˆ†å¸ƒï¼ˆGA4ã®regionãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ - å®Ÿéš›ã®ã‚¢ã‚¯ã‚»ã‚¹å…ƒåœ°åŸŸï¼‰
    function RegionDistribution({ data, loading }) {
      if (loading) return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100 h-full">
          <div className="space-y-2">{Array(5).fill(0).map((_, i) => <div key={i} className="h-4 bg-gray-200 rounded loading-pulse"></div>)}</div>
        </div>
      );

      if (!data || data.length === 0) {
        return (
          <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100 h-full">
            <h3 className="text-sm font-medium text-gray-700 mb-4">ã‚¢ã‚¯ã‚»ã‚¹å…ƒåœ°åŸŸï¼ˆGA4ï¼‰</h3>
            <p className="text-xs text-gray-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        );
      }

      return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100 h-full">
          <h3 className="text-sm font-medium text-gray-700 mb-4">ã‚¢ã‚¯ã‚»ã‚¹å…ƒåœ°åŸŸï¼ˆGA4 ä¸Šä½5ï¼‰</h3>
          <div className="space-y-2">
            {data.slice(0, 5).map((region, index) => (
              <div key={region.name} className="flex items-center justify-between text-xs">
                <div className="flex items-center"><span className="text-gray-400 w-5">{index + 1}.</span><span className="text-gray-700">{region.name}</span></div>
                <div className="flex items-center gap-3"><span className="text-gray-600">{region.sessions}</span><span className="text-gray-400">{region.percent}%</span></div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ãƒ‡ãƒã‚¤ã‚¹ãƒãƒ£ãƒ¼ãƒˆï¼ˆGA4ã‹ã‚‰å–å¾—ï¼‰
    function DeviceChart({ data, loading }) {
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      useEffect(() => {
        if (chartInstance.current) chartInstance.current.destroy();
        if (!data || data.length === 0) return;
        if (!chartRef.current) return;

        const ctx = chartRef.current.getContext('2d');
        chartInstance.current = new Chart(ctx, {
          type: 'doughnut',
          data: { labels: data.map(d => d.name), datasets: [{ data: data.map(d => d.value), backgroundColor: data.map(d => d.color), borderWidth: 0 }] },
          options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false } } }
        });
        return () => { if (chartInstance.current) chartInstance.current.destroy(); };
      }, [data, loading]);

      if (loading) {
        return (
          <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100 h-full">
            <h3 className="text-sm font-medium text-gray-700 mb-4">ãƒ‡ãƒã‚¤ã‚¹ï¼ˆGA4ï¼‰</h3>
            <div className="flex items-center justify-center h-20">
              <span className="text-gray-400 loading-pulse">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
          </div>
        );
      }

      if (!data || data.length === 0) {
        return (
          <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100 h-full">
            <h3 className="text-sm font-medium text-gray-700 mb-4">ãƒ‡ãƒã‚¤ã‚¹ï¼ˆGA4ï¼‰</h3>
            <p className="text-xs text-gray-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        );
      }

      return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100 h-full">
          <h3 className="text-sm font-medium text-gray-700 mb-4">ãƒ‡ãƒã‚¤ã‚¹ï¼ˆGA4ï¼‰</h3>
          <div className="flex items-center gap-6">
            <div style={{ width: '80px', height: '80px' }}><canvas ref={chartRef}></canvas></div>
            <div className="flex-1 space-y-2">
              {data.map((item, i) => (
                <div key={i} className="flex items-center justify-between text-xs">
                  <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{ backgroundColor: item.color }}></div><span>{item.name}</span></div>
                  <span className="font-medium">{item.value}%</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // æ¥å ´çµ„ç¹”ãƒªã‚¹ãƒˆ
    function OrganizationList({ companies, loading }) {
      const [sortConfig, setSortConfig] = useState({ key: 'sessions', direction: 'desc' });
      const [searchTerm, setSearchTerm] = useState('');
      const [displayCount, setDisplayCount] = useState(50);
      const displayOptions = [50, 100, 250, 500, 1000];

      const handleSort = (key) => {
        setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc' }));
      };

      const sortedData = [...companies].sort((a, b) => {
        const aVal = a[sortConfig.key];
        const bVal = b[sortConfig.key];
        const modifier = sortConfig.direction === 'asc' ? 1 : -1;
        if (typeof aVal === 'number') return (aVal - bVal) * modifier;
        return String(aVal || '').localeCompare(String(bVal || '')) * modifier;
      }).filter(c => !searchTerm || c.name?.toLowerCase().includes(searchTerm.toLowerCase()));

      const columns = [
        { key: 'name', label: 'çµ„ç¹”å' }, { key: 'prefecture', label: 'éƒ½é“åºœçœŒ' },
        { key: 'industry', label: 'æ¥­ç¨®' }, { key: 'capitalStock', label: 'è³‡æœ¬é‡‘' }, { key: 'sales', label: 'å£²ä¸Šé«˜' },
        { key: 'sessions', label: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³' }, { key: 'pageViews', label: 'PV' }
      ];

      if (loading) return (
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-10">
          <div className="text-center text-gray-400 loading-pulse">ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      );

      return (
        <div className="bg-white rounded-xl shadow-sm border border-gray-100">
          <div className="p-4 border-b border-gray-100 flex items-center justify-between">
            <input type="text" placeholder="ä¼æ¥­åã§æ¤œç´¢..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
              className="px-3 py-1.5 text-xs border rounded-lg w-48 focus:ring-2 focus:ring-primary-500" />
            <div className="flex items-center gap-3">
              <select value={displayCount} onChange={e => setDisplayCount(Number(e.target.value))}
                className="px-2 py-1 text-xs border rounded-lg focus:ring-2 focus:ring-primary-500">
                {displayOptions.map(n => <option key={n} value={n}>{n}ä»¶è¡¨ç¤º</option>)}
              </select>
              <div className="text-xs text-gray-500">{sortedData.length} ä»¶ä¸­</div>
            </div>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-xs">
              <thead>
                <tr className="bg-primary-600 text-white">
                  {columns.map(col => (
                    <th key={col.key} className="px-3 py-2 text-left font-medium cursor-pointer hover:bg-primary-700" onClick={() => handleSort(col.key)}>
                      {col.label}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {sortedData.slice(0, displayCount).map((row, index) => (
                  <tr key={index} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-primary-50`}>
                    <td className="px-3 py-1.5 font-medium">{row.name || 'ä¸æ˜'}</td>
                    <td className="px-3 py-1.5">{row.prefecture || '-'}</td>
                    <td className="px-3 py-1.5">{row.industry || '-'}</td>
                    <td className="px-3 py-1.5">{row.capitalStock || '-'}</td>
                    <td className="px-3 py-1.5">{row.sales || '-'}</td>
                    <td className="px-3 py-1.5 text-right font-medium">{row.sessions?.toLocaleString() || 0}</td>
                    <td className="px-3 py-1.5 text-right">{row.pageViews?.toLocaleString() || 0}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // ========== ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ ==========
    function TopPage({ projects, onCreateNew, onSelectProject, onDeleteProject }) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-primary-50 to-blue-50">
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <header className="bg-white shadow-sm">
            <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-primary-600 rounded-xl flex items-center justify-center">
                  <span className="text-white font-bold text-lg">E</span>
                </div>
                <div>
                  <h1 className="text-xl font-bold text-gray-800">evort Analytics</h1>
                  <p className="text-xs text-gray-500">GA4é€£æºã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ç®¡ç†</p>
                </div>
              </div>
            </div>
          </header>

          {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
          <main className="max-w-6xl mx-auto px-6 py-10">
            {/* æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ */}
            <div className="mb-8">
              <button onClick={onCreateNew}
                className="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
                <span className="text-xl">+</span>
                æ–°è¦ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ä½œæˆ
              </button>
            </div>

            {/* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ */}
            <div>
              <h2 className="text-lg font-bold text-gray-800 mb-4">ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ä¸€è¦§</h2>
              {projects.length === 0 ? (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
                  <div className="text-6xl mb-4">ğŸ“Š</div>
                  <p className="text-gray-500 mb-2">ã¾ã ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“</p>
                  <p className="text-sm text-gray-400">ã€Œæ–°è¦ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {projects.map(project => (
                    <div key={project.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 hover:shadow-md transition-shadow">
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center">
                            <span className="text-primary-600 font-bold text-lg">{project.name.charAt(0)}</span>
                          </div>
                          <div>
                            <h3 className="font-bold text-gray-800">{project.name}</h3>
                            <p className="text-xs text-gray-400">/{project.slug}</p>
                          </div>
                        </div>
                        <button onClick={() => onDeleteProject(project.id)} className="text-gray-400 hover:text-red-500 text-sm">âœ•</button>
                      </div>
                      <div className="flex items-center gap-2 mb-4 text-xs text-gray-500">
                        <span>ğŸ“ {Object.values(project.urlCategories || {}).flat().length} URL</span>
                        <span>ğŸš« {(project.orgExclusions || []).length} é™¤å¤–</span>
                      </div>
                      <button onClick={() => onSelectProject(project)}
                        className="w-full py-2 bg-primary-50 text-primary-600 rounded-lg text-sm font-medium hover:bg-primary-100 transition-colors">
                        ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã â†’
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </main>
        </div>
      );
    }

    // ========== æ–°è¦ä½œæˆ/ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  ==========
    function ProjectForm({ project, onSave, onCancel }) {
      const [name, setName] = useState(project?.name || '');
      const [slug, setSlug] = useState(project?.slug || '');
      const [urlCategories, setUrlCategories] = useState(project?.urlCategories || {
        'company-content': [],
        'media-content': [],
        'form-content': [],
        'exclude-content': [],
      });
      const [orgExclusions, setOrgExclusions] = useState(project?.orgExclusions || []);

      // URLè¿½åŠ ç”¨state
      const [newUrlCategory, setNewUrlCategory] = useState('company-content');
      const [newUrlTitle, setNewUrlTitle] = useState('');
      const [newUrlPath, setNewUrlPath] = useState('');
      const [newUrlMatchType, setNewUrlMatchType] = useState('prefix');

      // çµ„ç¹”é™¤å¤–ç”¨state
      const [newExclusionType, setNewExclusionType] = useState('name');
      const [newExclusionValue, setNewExclusionValue] = useState('');

      const isEditing = !!project;

      const addUrl = () => {
        if (!newUrlTitle.trim() || !newUrlPath.trim()) return;
        const newItem = { id: Date.now(), title: newUrlTitle.trim(), url: newUrlPath.trim(), matchType: newUrlMatchType };
        setUrlCategories({
          ...urlCategories,
          [newUrlCategory]: [...(urlCategories[newUrlCategory] || []), newItem]
        });
        setNewUrlTitle('');
        setNewUrlPath('');
      };

      const removeUrl = (categoryId, urlId) => {
        setUrlCategories({
          ...urlCategories,
          [categoryId]: urlCategories[categoryId].filter(u => u.id !== urlId)
        });
      };

      const addExclusion = () => {
        if (!newExclusionValue.trim()) return;
        const newExc = { id: Date.now(), type: newExclusionType, value: newExclusionValue.trim() };
        setOrgExclusions([...orgExclusions, newExc]);
        setNewExclusionValue('');
      };

      const removeExclusion = (id) => {
        setOrgExclusions(orgExclusions.filter(e => e.id !== id));
      };

      const handleSave = () => {
        if (!name.trim() || !slug.trim()) {
          alert('ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹åã¨slugã¯å¿…é ˆã§ã™');
          return;
        }
        const projectData = {
          id: project?.id || Date.now(),
          name: name.trim(),
          slug: slug.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-'),
          urlCategories,
          orgExclusions,
          createdAt: project?.createdAt || new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        };
        onSave(projectData);
      };

      const colorClasses = {
        blue: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700' },
        green: { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-700' },
        purple: { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-700' },
        red: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-700' },
      };

      const typeLabels = { name: 'çµ„ç¹”å', industry: 'æ¥­ç¨®', prefecture: 'éƒ½é“åºœçœŒ', employees: 'å¾“æ¥­å“¡æ•°' };

      return (
        <div className="min-h-screen bg-gray-50">
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <header className="bg-white shadow-sm sticky top-0 z-10">
            <div className="max-w-4xl mx-auto px-6 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <button onClick={onCancel} className="text-gray-500 hover:text-gray-700">â† æˆ»ã‚‹</button>
                <h1 className="text-lg font-bold text-gray-800">{isEditing ? 'ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ç·¨é›†' : 'æ–°è¦ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ä½œæˆ'}</h1>
              </div>
              <button onClick={handleSave}
                className="px-5 py-2 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700">
                {isEditing ? 'ä¿å­˜' : 'ä½œæˆ'}
              </button>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-6 py-8">
            {/* åŸºæœ¬æƒ…å ± */}
            <section className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
              <h2 className="text-lg font-bold text-gray-800 mb-4">åŸºæœ¬æƒ…å ±</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹å *</label>
                  <input type="text" value={name} onChange={e => setName(e.target.value)}
                    placeholder="ä¾‹ï¼šæ–‰è—¤å…‰å­¦" className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Slugï¼ˆURLç”¨ï¼‰ *</label>
                  <div className="flex items-center">
                    <span className="text-gray-400 mr-1">/</span>
                    <input type="text" value={slug} onChange={e => setSlug(e.target.value)}
                      placeholder="ä¾‹ï¼šsaito-hk" className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500" />
                  </div>
                  <p className="text-xs text-gray-400 mt-1">è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½</p>
                </div>
              </div>
            </section>

            {/* URLã‚«ãƒ†ã‚´ãƒªè¨­å®š */}
            <section className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
              <h2 className="text-lg font-bold text-gray-800 mb-4">URLè¨­å®š</h2>
              <p className="text-sm text-gray-500 mb-6">å„ã‚«ãƒ†ã‚´ãƒªã«URLã‚’è¿½åŠ ã™ã‚‹ã¨ã€ãã®URLã‚’é–²è¦§ã—ãŸä¼æ¥­ã‚’åˆ†æã§ãã¾ã™</p>

              {/* URLè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */}
              <div className="bg-gray-50 rounded-xl p-4 mb-6">
                <h3 className="text-sm font-medium text-gray-700 mb-3">URLã‚’è¿½åŠ </h3>
                <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select value={newUrlCategory} onChange={e => setNewUrlCategory(e.target.value)}
                      className="w-full px-3 py-2 text-sm border rounded-lg">
                      {URL_CATEGORIES.map(cat => <option key={cat.id} value={cat.id}>{cat.label}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" value={newUrlTitle} onChange={e => setNewUrlTitle(e.target.value)}
                      placeholder="USBãƒã‚¤ã‚¯ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—" className="w-full px-3 py-2 text-sm border rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">URLãƒ‘ã‚¹</label>
                    <input type="text" value={newUrlPath} onChange={e => setNewUrlPath(e.target.value)}
                      placeholder="/products/usb" className="w-full px-3 py-2 text-sm border rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">ãƒãƒƒãƒ</label>
                    <select value={newUrlMatchType} onChange={e => setNewUrlMatchType(e.target.value)}
                      className="w-full px-3 py-2 text-sm border rounded-lg">
                      <option value="prefix">å‰æ–¹ä¸€è‡´</option>
                      <option value="exact">å®Œå…¨ä¸€è‡´</option>
                      <option value="contains">å«ã‚€</option>
                    </select>
                  </div>
                  <div className="flex items-end">
                    <button onClick={addUrl} className="w-full px-4 py-2 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700">è¿½åŠ </button>
                  </div>
                </div>
              </div>

              {/* ã‚«ãƒ†ã‚´ãƒªåˆ¥ä¸€è¦§ */}
              {URL_CATEGORIES.map(category => {
                const urls = urlCategories[category.id] || [];
                const colors = colorClasses[category.color];
                return (
                  <div key={category.id} className={`rounded-xl border ${colors.border} p-4 mb-3`}>
                    <div className="flex items-center justify-between mb-2">
                      <h4 className={`text-sm font-medium ${colors.text} flex items-center gap-2`}>
                        {category.label}
                        <span className="text-xs bg-white px-2 py-0.5 rounded-full">{urls.length}ä»¶</span>
                      </h4>
                    </div>
                    {urls.length === 0 ? (
                      <p className="text-xs text-gray-400">{category.description}</p>
                    ) : (
                      <div className="space-y-1">
                        {urls.map(item => (
                          <div key={item.id} className={`flex items-center justify-between ${colors.bg} px-3 py-2 rounded-lg`}>
                            <div className="flex items-center gap-2 text-sm">
                              <span className={`font-medium ${colors.text}`}>{item.title}</span>
                              <code className="text-xs bg-white px-2 py-0.5 rounded border">{item.url}</code>
                              <span className="text-xs text-gray-400">{item.matchType === 'exact' ? 'å®Œå…¨ä¸€è‡´' : item.matchType === 'contains' ? 'å«ã‚€' : 'å‰æ–¹ä¸€è‡´'}</span>
                            </div>
                            <button onClick={() => removeUrl(category.id, item.id)} className="text-red-400 hover:text-red-600">âœ•</button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </section>

            {/* çµ„ç¹”é™¤å¤–è¨­å®š */}
            <section className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
              <h2 className="text-lg font-bold text-gray-800 mb-4">çµ„ç¹”é™¤å¤–è¨­å®š</h2>
              <p className="text-sm text-gray-500 mb-6">ç‰¹å®šã®çµ„ç¹”ã‚„æ¡ä»¶ã«è©²å½“ã™ã‚‹ä¼æ¥­ã‚’è¡¨ç¤ºã‹ã‚‰é™¤å¤–ã—ã¾ã™</p>

              {/* é™¤å¤–è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */}
              <div className="bg-gray-50 rounded-xl p-4 mb-6">
                <h3 className="text-sm font-medium text-gray-700 mb-3">é™¤å¤–æ¡ä»¶ã‚’è¿½åŠ </h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">é™¤å¤–ã‚¿ã‚¤ãƒ—</label>
                    <select value={newExclusionType} onChange={e => setNewExclusionType(e.target.value)}
                      className="w-full px-3 py-2 text-sm border rounded-lg">
                      <option value="name">çµ„ç¹”å</option>
                      <option value="industry">æ¥­ç¨®</option>
                      <option value="prefecture">éƒ½é“åºœçœŒ</option>
                      <option value="employees">å¾“æ¥­å“¡æ•°</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">é™¤å¤–ã™ã‚‹å€¤</label>
                    <input type="text" value={newExclusionValue} onChange={e => setNewExclusionValue(e.target.value)}
                      placeholder="ä¾‹ï¼šè‡ªç¤¾åã€(not set)" className="w-full px-3 py-2 text-sm border rounded-lg" />
                  </div>
                  <div className="flex items-end">
                    <button onClick={addExclusion} className="w-full px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700">é™¤å¤–è¿½åŠ </button>
                  </div>
                </div>
              </div>

              {/* é™¤å¤–ä¸€è¦§ */}
              {orgExclusions.length === 0 ? (
                <p className="text-sm text-gray-400 text-center py-4">é™¤å¤–æ¡ä»¶ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
              ) : (
                <div className="flex flex-wrap gap-2">
                  {orgExclusions.map(exc => (
                    <span key={exc.id} className="inline-flex items-center gap-1 bg-red-50 text-red-700 px-3 py-1 rounded-full text-sm border border-red-200">
                      <span className="text-xs text-red-400">{typeLabels[exc.type]}:</span>
                      {exc.value}
                      <button onClick={() => removeExclusion(exc.id)} className="ml-1 text-red-400 hover:text-red-600">âœ•</button>
                    </span>
                  ))}
                </div>
              )}
            </section>
          </main>
        </div>
      );
    }

    // ========== å€‹åˆ¥ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ==========
    function AnalyticsDashboard({ project, onBack, onEdit }) {
      const [activeItem, setActiveItem] = useState('dashboard');
      const [dateRange, setDateRange] = useState('30daysAgo');
      const [allCompaniesData, setAllCompaniesData] = useState({ combined: [], subpages: {} }); // å„URLã”ã¨ã®ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ï¼ˆã©ã“ã©ã“JPï¼‰
      const [subpagesData, setSubpagesData] = useState({}); // å„è¦ªURLã®å­ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿
      const [ga4Metrics, setGa4Metrics] = useState({ pageViews: 0, sessions: 0, activeUsers: 0, avgSessionDuration: 0 }); // GA4ãƒ¡ãƒˆãƒªã‚¯ã‚¹
      const [dailyTrendData, setDailyTrendData] = useState([]); // GA4æ—¥åˆ¥æ¨ç§»ãƒ‡ãƒ¼ã‚¿
      const [regionData, setRegionData] = useState([]); // GA4åœ°åŸŸãƒ‡ãƒ¼ã‚¿
      const [deviceData, setDeviceData] = useState([]); // GA4ãƒ‡ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿
      const [loading, setLoading] = useState(true);
      const [expandedUrls, setExpandedUrls] = useState({}); // å±•é–‹çŠ¶æ…‹

      const urlCategories = project.urlCategories || {};
      const orgExclusions = project.orgExclusions || [];

      // è¨ˆæ¸¬å¯¾è±¡ã®URLä¸€è¦§ã‚’å–å¾—ï¼ˆé™¤å¤–URLä»¥å¤–ï¼‰
      const getTargetUrls = () => {
        const urls = [];
        ['company-content', 'media-content', 'form-content'].forEach(catId => {
          (urlCategories[catId] || []).forEach(item => {
            urls.push({ ...item, category: catId });
          });
        });
        return urls;
      };

      // é™¤å¤–URLã®ä¸€è¦§
      const getExcludeUrls = () => {
        return urlCategories['exclude-content'] || [];
      };

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ/previewã‚’å«ã‚€URLï¼‰
      const DEFAULT_EXCLUDE_PATTERNS = ['/preview'];

      // URLãŒé™¤å¤–å¯¾è±¡ã‹ãƒã‚§ãƒƒã‚¯
      const isExcludedUrl = (path) => {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯
        if (DEFAULT_EXCLUDE_PATTERNS.some(pattern => path.includes(pattern))) return true;
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®é™¤å¤–URLãƒã‚§ãƒƒã‚¯
        const excludeUrls = getExcludeUrls();
        return excludeUrls.some(ex => path.startsWith(ex.url) || path === ex.url);
      };

      // ç¾åœ¨é¸æŠä¸­ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æƒ…å ±ã‚’å–å¾—
      const getActiveFilter = () => {
        if (activeItem === 'dashboard') {
          return { type: 'all', categoryId: null, urlId: null };
        }
        // ã‚«ãƒ†ã‚´ãƒªãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆcompany-content, media-content, form-contentï¼‰
        if (['company-content', 'media-content', 'form-content'].includes(activeItem)) {
          return { type: 'category', categoryId: activeItem, urlId: null };
        }
        // å­ãƒšãƒ¼ã‚¸ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆsubpage-è¦ªID-ãƒ‘ã‚¹ï¼‰
        if (activeItem.startsWith('subpage-')) {
          const parts = activeItem.split('-');
          const parentId = parseInt(parts[1]);
          const subpagePath = decodeURIComponent(parts.slice(2).join('-'));
          // è¦ªURLã‚’æ¢ã™
          for (const catId of Object.keys(urlCategories)) {
            const parentItem = urlCategories[catId]?.find(u => u.id === parentId);
            if (parentItem) {
              const subpage = subpagesData[parentItem.url]?.find(p => p.path === subpagePath);
              return {
                type: 'subpage',
                categoryId: catId,
                parentId,
                parentUrl: parentItem.url,
                url: subpagePath,
                title: subpage?.title || subpagePath
              };
            }
          }
        }
        // è¦ªURLãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
        if (activeItem.startsWith('url-')) {
          const urlId = parseInt(activeItem.replace('url-', ''));
          for (const catId of Object.keys(urlCategories)) {
            const urlItem = urlCategories[catId]?.find(u => u.id === urlId);
            if (urlItem) return { type: 'url', categoryId: catId, urlId, url: urlItem.url, title: urlItem.title };
          }
        }
        return { type: 'all', categoryId: null, urlId: null };
      };

      const activeFilter = getActiveFilter();
      const targetUrls = getTargetUrls();
      const excludeUrls = getExcludeUrls();

      const loadData = useCallback(async () => {
        setLoading(true);
        try {
          // ç™»éŒ²ã•ã‚ŒãŸURLãŒãªã„å ´åˆã¯ç©ºãƒ‡ãƒ¼ã‚¿
          if (targetUrls.length === 0) {
            setGa4Metrics({ pageViews: 0, activeUsers: 0, sessions: 0, avgSessionDuration: 0 });
            setDailyTrendData([]);
            setRegionData([]);
            setDeviceData([]);
            setAllCompaniesData({ combined: [], subpages: {} });
            setSubpagesData({});
            setLoading(false);
            return;
          }

          // URLãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ï¼ˆç¾åœ¨ã®activeItemã«åŸºã¥ãï¼‰
          let urlsToFetch = []; // è¤‡æ•°URLå–å¾—ç”¨
          let singleUrlFilter = null;
          let urlMatchType = 'prefix';

          if (activeFilter.type === 'all') {
            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: å…¨ç™»éŒ²URLã®ãƒ‡ãƒ¼ã‚¿ã‚’å€‹åˆ¥ã«å–å¾—ã—ã¦åˆç®—
            urlsToFetch = targetUrls.map(u => u.url);
          } else if (activeFilter.type === 'category') {
            // ã‚«ãƒ†ã‚´ãƒª: ãã®ã‚«ãƒ†ã‚´ãƒªå†…ã®URLã‚’å€‹åˆ¥ã«å–å¾—ã—ã¦åˆç®—
            urlsToFetch = targetUrls.filter(u => u.category === activeFilter.categoryId).map(u => u.url);
          } else if (activeFilter.type === 'url') {
            // è¦ªURLé¸æŠæ™‚: ãã®URLï¼ˆå‰æ–¹ä¸€è‡´ã§é…ä¸‹ã‚‚å«ã‚€ï¼‰
            singleUrlFilter = activeFilter.url;
            urlMatchType = 'prefix';
          } else if (activeFilter.type === 'subpage') {
            // å­ãƒšãƒ¼ã‚¸é¸æŠæ™‚: å®Œå…¨ä¸€è‡´
            singleUrlFilter = activeFilter.url;
            urlMatchType = 'exact';
          }

          // GA4ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆè¤‡æ•°URLã®å ´åˆã¯å€‹åˆ¥å–å¾—ã—ã¦åˆç®—ï¼‰
          let ga4Promises;
          if (urlsToFetch.length > 0) {
            // å„URLã”ã¨ã«GA4ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åˆç®—
            const overviewPromises = urlsToFetch.map(url =>
              fetchGA4({ type: 'overview-by-url', startDate: dateRange, endDate: 'today', url, urlMatchType: 'prefix' })
                .catch(() => ({ data: { pageViews: 0, sessions: 0, activeUsers: 0, avgSessionDuration: 0 } }))
            );
            const trendPromises = urlsToFetch.map(url =>
              fetchGA4({ type: 'daily-trend', startDate: dateRange, endDate: 'today', url, urlMatchType: 'prefix' })
                .catch(() => ({ data: [] }))
            );
            const regionPromises = urlsToFetch.map(url =>
              fetchGA4({ type: 'regions', startDate: dateRange, endDate: 'today', url, urlMatchType: 'prefix' })
                .catch(() => ({ data: [] }))
            );
            const devicePromises = urlsToFetch.map(url =>
              fetchGA4({ type: 'devices', startDate: dateRange, endDate: 'today', url, urlMatchType: 'prefix' })
                .catch(() => ({ data: [] }))
            );

            const [overviewResults, trendResults, regionResults, deviceResults] = await Promise.all([
              Promise.all(overviewPromises),
              Promise.all(trendPromises),
              Promise.all(regionPromises),
              Promise.all(devicePromises),
            ]);

            // Overviewåˆç®—
            const aggregatedOverview = overviewResults.reduce((acc, res) => {
              const d = res.data || {};
              acc.pageViews += d.pageViews || 0;
              acc.sessions += d.sessions || 0;
              acc.activeUsers += d.activeUsers || 0;
              acc.avgSessionDuration += d.avgSessionDuration || 0;
              return acc;
            }, { pageViews: 0, sessions: 0, activeUsers: 0, avgSessionDuration: 0 });
            if (overviewResults.length > 0) {
              aggregatedOverview.avgSessionDuration /= overviewResults.length;
            }

            // Trendåˆç®—ï¼ˆæ—¥ä»˜ã§ãƒãƒ¼ã‚¸ï¼‰
            const trendMap = new Map();
            trendResults.forEach(res => {
              (res.data || []).forEach(d => {
                if (trendMap.has(d.date)) {
                  const existing = trendMap.get(d.date);
                  existing.pv += d.pv || 0;
                  existing.sessions += d.sessions || 0;
                  existing.users += d.users || 0;
                } else {
                  trendMap.set(d.date, { date: d.date, pv: d.pv || 0, sessions: d.sessions || 0, users: d.users || 0 });
                }
              });
            });
            const aggregatedTrend = Array.from(trendMap.values()).sort((a, b) => a.date.localeCompare(b.date));

            // Regionåˆç®—
            const regionMap = new Map();
            regionResults.forEach(res => {
              (res.data || []).forEach(r => {
                if (regionMap.has(r.name)) {
                  const existing = regionMap.get(r.name);
                  existing.sessions += r.sessions || 0;
                  existing.users += r.users || 0;
                  existing.pageViews += r.pageViews || 0;
                } else {
                  regionMap.set(r.name, { ...r });
                }
              });
            });
            const aggregatedRegions = Array.from(regionMap.values())
              .sort((a, b) => b.sessions - a.sessions)
              .slice(0, 20);
            const totalRegionSessions = aggregatedRegions.reduce((sum, r) => sum + r.sessions, 0) || 1;
            aggregatedRegions.forEach(r => { r.percent = ((r.sessions / totalRegionSessions) * 100).toFixed(1); });

            // Deviceåˆç®—
            const deviceMap = new Map();
            deviceResults.forEach(res => {
              (res.data || []).forEach(d => {
                if (deviceMap.has(d.name)) {
                  const existing = deviceMap.get(d.name);
                  existing.sessions += d.sessions || 0;
                } else {
                  deviceMap.set(d.name, { ...d, sessions: d.sessions || 0 });
                }
              });
            });
            const totalDeviceSessions = Array.from(deviceMap.values()).reduce((sum, d) => sum + d.sessions, 0) || 1;
            const aggregatedDevices = Array.from(deviceMap.values()).map(d => ({
              ...d,
              value: Math.round((d.sessions / totalDeviceSessions) * 100),
            }));

            ga4Promises = [
              Promise.resolve({ data: aggregatedOverview }),
              Promise.resolve({ data: aggregatedTrend }),
              Promise.resolve({ data: aggregatedRegions }),
              Promise.resolve({ data: aggregatedDevices }),
            ];
          } else {
            // å˜ä¸€URLå–å¾—
            ga4Promises = [
              fetchGA4({ type: 'overview-by-url', startDate: dateRange, endDate: 'today', url: singleUrlFilter, urlMatchType })
                .catch(() => ({ data: { pageViews: 0, sessions: 0, activeUsers: 0, avgSessionDuration: 0 } })),
              fetchGA4({ type: 'daily-trend', startDate: dateRange, endDate: 'today', url: singleUrlFilter, urlMatchType })
                .catch(() => ({ data: [] })),
              fetchGA4({ type: 'regions', startDate: dateRange, endDate: 'today', url: singleUrlFilter, urlMatchType })
                .catch(() => ({ data: [] })),
              fetchGA4({ type: 'devices', startDate: dateRange, endDate: 'today', url: singleUrlFilter, urlMatchType })
                .catch(() => ({ data: [] })),
            ];
          }

          // ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ï¼ˆã©ã“ã©ã“JPï¼‰ã¯å¼•ãç¶šãå–å¾—
          // å„URLã”ã¨ã«ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå‰æ–¹ä¸€è‡´=ã‚«ãƒ†ã‚´ãƒªç”¨ï¼‰
          const urlPrefixPromises = targetUrls.map(urlItem =>
            fetchGA4({ type: 'companies', startDate: dateRange, endDate: 'today', url: urlItem.url, urlMatchType: 'prefix' })
              .then(res => ({ urlItem, companies: res.data || [], matchType: 'prefix' }))
              .catch(() => ({ urlItem, companies: [], matchType: 'prefix' }))
          );

          // å„URLã”ã¨ã«ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå®Œå…¨ä¸€è‡´=å€‹åˆ¥URLç”¨ï¼‰
          const urlExactPromises = targetUrls.map(urlItem =>
            fetchGA4({ type: 'companies', startDate: dateRange, endDate: 'today', url: urlItem.url, urlMatchType: 'exact' })
              .then(res => ({ urlItem, companies: res.data || [], matchType: 'exact' }))
              .catch(() => ({ urlItem, companies: [], matchType: 'exact' }))
          );

          // å­ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const subpagePromises = targetUrls.map(urlItem =>
            fetchGA4({ type: 'subpages', startDate: dateRange, endDate: 'today', url: urlItem.url })
              .then(res => ({ parentUrl: urlItem.url, pages: res.data?.pages || [] }))
              .catch(() => ({ parentUrl: urlItem.url, pages: [] }))
          );

          const [ga4Results, prefixResults, exactResults, subpageResults] = await Promise.all([
            Promise.all(ga4Promises),
            Promise.all(urlPrefixPromises),
            Promise.all(urlExactPromises),
            Promise.all(subpagePromises),
          ]);

          // GA4ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
          const [overviewRes, trendRes, regionsRes, devicesRes] = ga4Results;
          setGa4Metrics(overviewRes.data || { pageViews: 0, sessions: 0, activeUsers: 0, avgSessionDuration: 0 });
          setDailyTrendData(trendRes.data || []);
          setRegionData(regionsRes.data || []);
          setDeviceData(devicesRes.data || []);

          // å­ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
          const subpagesObj = {};
          const expandState = {};
          subpageResults.forEach(({ parentUrl, pages }) => {
            const seenPaths = new Set();
            const parentSegment = parentUrl.split('/').filter(s => s).pop();

            subpagesObj[parentUrl] = pages.filter(p => {
              if (p.path === parentUrl) return false;
              if (!p.path.startsWith(parentUrl)) return false;
              if (isExcludedUrl(p.path)) return false;
              if (seenPaths.has(p.path)) return false;
              seenPaths.add(p.path);
              const relativePath = p.path.slice(parentUrl.length);
              const segments = relativePath.split('/').filter(s => s);
              if (segments.length !== 1) return false;
              if (segments[0] === parentSegment) return false;
              return true;
            });

            targetUrls.forEach(u => {
              if (u.url === parentUrl && subpagesObj[parentUrl].length > 0) {
                expandState[u.id] = true;
              }
            });
          });
          setSubpagesData(subpagesObj);
          setExpandedUrls(prev => ({ ...prev, ...expandState }));

          // å­ãƒšãƒ¼ã‚¸ã”ã¨ã®ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰
          const allSubpages = [];
          Object.entries(subpagesObj).forEach(([parentUrl, pages]) => {
            pages.forEach(page => allSubpages.push({ parentUrl, path: page.path }));
          });

          const subpageExactPromises = allSubpages.map(({ parentUrl, path }) =>
            fetchGA4({ type: 'companies', startDate: dateRange, endDate: 'today', url: path, urlMatchType: 'exact' })
              .then(res => ({ parentUrl, path, companies: res.data || [] }))
              .catch(() => ({ parentUrl, path, companies: [] }))
          );

          const subpageExactResults = await Promise.all(subpageExactPromises);

          // ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã‚‹
          const combinedData = targetUrls.map((urlItem, idx) => ({
            urlItem,
            companiesPrefix: prefixResults[idx]?.companies || [],
            companiesExact: exactResults[idx]?.companies || [],
          }));

          const subpageCompaniesObj = {};
          subpageExactResults.forEach(({ parentUrl, path, companies }) => {
            if (!subpageCompaniesObj[parentUrl]) subpageCompaniesObj[parentUrl] = {};
            subpageCompaniesObj[parentUrl][path] = companies;
          });

          setAllCompaniesData({ combined: combinedData, subpages: subpageCompaniesObj });

        } catch (err) {
          console.error('Data load error:', err);
          setGa4Metrics({ pageViews: 0, activeUsers: 0, sessions: 0, avgSessionDuration: 0 });
          setDailyTrendData([]);
          setRegionData([]);
          setDeviceData([]);
          setAllCompaniesData({ combined: [], subpages: {} });
          setSubpagesData({});
        } finally {
          setLoading(false);
        }
      }, [dateRange, activeItem, JSON.stringify(targetUrls)]);

      useEffect(() => { loadData(); }, [loadData]);

      // è¡¨ç¤ºã™ã‚‹ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—
      const getDisplayCompanies = () => {
        const companyMap = new Map();
        const { combined = [], subpages = {} } = allCompaniesData || {};

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’çµã‚Šè¾¼ã¿
        if (activeFilter.type === 'all') {
          // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼šå…¨URLåˆç®—ï¼ˆå‰æ–¹ä¸€è‡´ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
          combined.forEach(({ companiesPrefix }) => {
            companiesPrefix.forEach(company => {
              const key = company.name || 'ä¸æ˜';
              if (companyMap.has(key)) {
                const existing = companyMap.get(key);
                existing.sessions += company.sessions || 0;
                existing.pageViews += company.pageViews || 0;
              } else {
                companyMap.set(key, { ...company });
              }
            });
          });
        } else if (activeFilter.type === 'category') {
          // ã‚«ãƒ†ã‚´ãƒªï¼šãã®ã‚«ãƒ†ã‚´ãƒªå†…ã®URLå…¨ã¦ï¼ˆå‰æ–¹ä¸€è‡´ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
          combined.filter(r => r.urlItem.category === activeFilter.categoryId).forEach(({ companiesPrefix }) => {
            companiesPrefix.forEach(company => {
              const key = company.name || 'ä¸æ˜';
              if (companyMap.has(key)) {
                const existing = companyMap.get(key);
                existing.sessions += company.sessions || 0;
                existing.pageViews += company.pageViews || 0;
              } else {
                companyMap.set(key, { ...company });
              }
            });
          });
        } else if (activeFilter.type === 'url') {
          // è¦ªURLï¼šå®Œå…¨ä¸€è‡´ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä½¿ç”¨ï¼ˆå­ãƒšãƒ¼ã‚¸ã¯å«ã¾ãªã„ï¼‰
          combined.filter(r => r.urlItem.url === activeFilter.url).forEach(({ companiesExact }) => {
            companiesExact.forEach(company => {
              const key = company.name || 'ä¸æ˜';
              if (companyMap.has(key)) {
                const existing = companyMap.get(key);
                existing.sessions += company.sessions || 0;
                existing.pageViews += company.pageViews || 0;
              } else {
                companyMap.set(key, { ...company });
              }
            });
          });
        } else if (activeFilter.type === 'subpage') {
          // å­ãƒšãƒ¼ã‚¸ï¼šå®Œå…¨ä¸€è‡´ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä½¿ç”¨
          const subpageCompanies = subpages[activeFilter.parentUrl]?.[activeFilter.url] || [];
          subpageCompanies.forEach(company => {
            const key = company.name || 'ä¸æ˜';
            if (companyMap.has(key)) {
              const existing = companyMap.get(key);
              existing.sessions += company.sessions || 0;
              existing.pageViews += company.pageViews || 0;
            } else {
              companyMap.set(key, { ...company });
            }
          });
        }

        return Array.from(companyMap.values());
      };

      // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«å¿œã˜ãŸå¯¾è±¡URLæ•°ã‚’å–å¾—
      const getFilteredTargetUrls = () => {
        if (activeFilter.type === 'all') return targetUrls;
        if (activeFilter.type === 'category') {
          return targetUrls.filter(u => u.category === activeFilter.categoryId);
        }
        if (activeFilter.type === 'url' || activeFilter.type === 'subpage') {
          return targetUrls.filter(u => u.url === (activeFilter.parentUrl || activeFilter.url));
        }
        return targetUrls;
      };
      const filteredTargetUrls = getFilteredTargetUrls();

      // çµ„ç¹”é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ï¼ˆã©ã“ã©ã“JPã®ä¼æ¥­ãƒªã‚¹ãƒˆã®ã¿ï¼‰
      const companies = getDisplayCompanies();
      const filteredCompanies = companies.filter(company => {
        for (const exc of orgExclusions) {
          if (exc.type === 'name' && company.name === exc.value) return false;
          if (exc.type === 'industry' && company.industry === exc.value) return false;
          if (exc.type === 'prefecture' && company.prefecture === exc.value) return false;
          if (exc.type === 'employees' && company.employees === exc.value) return false;
        }
        return true;
      });

      // ç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«
      const getTitle = () => {
        if (activeFilter.type === 'all') return 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰';
        if (activeFilter.type === 'category') {
          const cat = URL_CATEGORIES.find(c => c.id === activeFilter.categoryId);
          return cat?.label || '';
        }
        if (activeFilter.type === 'url') {
          return activeFilter.title || '';
        }
        if (activeFilter.type === 'subpage') {
          // ã‚µãƒ–ãƒšãƒ¼ã‚¸ã¯GA4ã‹ã‚‰å–å¾—ã—ãŸãƒ•ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
          return activeFilter.title || '';
        }
        return '';
      };

      // ç¾åœ¨ã®URLï¼ˆãƒªãƒ³ã‚¯ç”¨ï¼‰
      const getCurrentUrl = () => {
        if (activeFilter.type === 'url' || activeFilter.type === 'subpage') {
          return activeFilter.url;
        }
        return null;
      };

      // URLãƒ‘ã‚¹ã®æœ«å°¾ã‚’å–å¾—ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤ºç”¨ï¼‰
      const getPathEnd = (path) => {
        const parts = path.split('/').filter(p => p);
        return parts[parts.length - 1] || path;
      };

      // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«æœ«å°¾ãƒˆãƒªãƒ ï¼ˆã€Œ| ã‚µã‚¤ãƒˆåã€ãªã©ã‚’é™¤å»ï¼‰
      const trimPageTitle = (title) => {
        if (!title) return '';
        // ãƒ‘ã‚¤ãƒ—åŒºåˆ‡ã‚Šã®æœ«å°¾ã‚’é™¤å»ï¼ˆä¾‹: "è£½å“ç´¹ä»‹ | evort ã‚¨ãƒœãƒ«ãƒˆ" â†’ "è£½å“ç´¹ä»‹"ï¼‰
        const pipeIndex = title.lastIndexOf(' | ');
        if (pipeIndex > 0) return title.substring(0, pipeIndex).trim();
        // ãƒã‚¤ãƒ•ãƒ³åŒºåˆ‡ã‚Šã®æœ«å°¾ã‚’é™¤å»ï¼ˆä¾‹: "è£½å“ç´¹ä»‹ - evort ã‚¨ãƒœãƒ«ãƒˆ" â†’ "è£½å“ç´¹ä»‹"ï¼‰
        const dashIndex = title.lastIndexOf(' - ');
        if (dashIndex > 0) return title.substring(0, dashIndex).trim();
        return title;
      };

      const dateOptions = [
        { label: '7æ—¥', value: '7daysAgo' }, { label: '30æ—¥', value: '30daysAgo' },
        { label: '90æ—¥', value: '90daysAgo' }, { label: '12ãƒ¶æœˆ', value: '365daysAgo' }
      ];

      return (
        <div className="flex min-h-screen">
          {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */}
          <div className="sidebar-fixed bg-white border-r border-gray-200 h-screen overflow-y-auto flex-shrink-0">
            <div className="p-4 border-b border-gray-100">
              <button onClick={onBack} className="text-xs text-gray-500 hover:text-gray-700 mb-2">â† ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-primary-600 rounded-lg flex items-center justify-center">
                  <span className="text-white font-bold">{project.name.charAt(0)}</span>
                </div>
                <div>
                  <h1 className="text-sm font-bold text-gray-800">{project.name}</h1>
                  <p className="text-xs text-gray-500">/{project.slug}</p>
                </div>
              </div>
            </div>

            <nav className="p-3">
              {/* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */}
              <button className={`w-full flex items-center px-3 py-2 rounded-lg text-left text-sm mb-1 ${activeItem === 'dashboard' ? 'bg-primary-50 text-primary-600' : 'text-gray-700 hover:bg-gray-50'}`}
                onClick={() => setActiveItem('dashboard')}>
                <span className="font-medium">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
              </button>

              {/* è¨­å®šç·¨é›† */}
              <button onClick={onEdit}
                className="w-full flex items-center px-3 py-2 rounded-lg text-left text-sm mb-3 text-gray-700 hover:bg-gray-50">
                <span className="font-medium">è¨­å®šã‚’ç·¨é›†</span>
              </button>

              <div className="border-t border-gray-100 pt-3 mb-2">
                <p className="text-xs text-gray-400 px-3 mb-2">URLã‚«ãƒ†ã‚´ãƒª</p>
              </div>

              {/* URLã‚«ãƒ†ã‚´ãƒª */}
              {URL_CATEGORIES.filter(c => c.id !== 'exclude-content').map(category => {
                const urls = urlCategories[category.id] || [];
                const isCategoryActive = activeItem === category.id;
                const hasUrls = urls.length > 0;
                return (
                  <div key={category.id} className="mb-1">
                    {/* ã‚«ãƒ†ã‚´ãƒªè¦‹å‡ºã—ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ */}
                    <button
                      className={`w-full px-3 py-2 text-sm flex items-center gap-2 rounded-lg text-left ${isCategoryActive ? 'bg-primary-50 text-primary-600' : 'text-gray-600 hover:bg-gray-50'}`}
                      onClick={() => setActiveItem(category.id)}
                      disabled={!hasUrls}
                    >
                      <span className="font-medium">{category.label}</span>
                      {hasUrls && <span className="text-xs bg-gray-100 px-1.5 py-0.5 rounded-full">{urls.length}</span>}
                    </button>
                    {/* è¦ªURL + å­ãƒšãƒ¼ã‚¸ */}
                    {hasUrls && (
                      <div className="ml-4 space-y-0.5 mt-1">
                        {urls.map(item => {
                          const subpages = subpagesData[item.url] || [];
                          const isExpanded = expandedUrls[item.id];
                          const isParentActive = activeItem === `url-${item.id}`;
                          return (
                            <div key={item.id}>
                              {/* è¦ªURL */}
                              <div className="flex items-center">
                                {subpages.length > 0 && (
                                  <button
                                    className="w-5 h-5 flex items-center justify-center text-gray-400 hover:text-gray-600"
                                    onClick={() => setExpandedUrls(prev => ({ ...prev, [item.id]: !prev[item.id] }))}
                                  >
                                    {isExpanded ? 'â–¼' : 'â–¶'}
                                  </button>
                                )}
                                {subpages.length === 0 && <span className="w-5" />}
                                <button
                                  className={`flex-1 px-2 py-1.5 rounded text-left text-xs ${isParentActive ? 'bg-primary-100 text-primary-700 font-medium' : 'text-gray-600 hover:bg-gray-50'}`}
                                  onClick={() => setActiveItem(`url-${item.id}`)}
                                >
                                  {item.title}
                                  {subpages.length > 0 && <span className="text-gray-400 ml-1">({subpages.length})</span>}
                                </button>
                              </div>
                              {/* å­ãƒšãƒ¼ã‚¸ï¼ˆå±•é–‹æ™‚ï¼‰ */}
                              {isExpanded && subpages.length > 0 && (
                                <div className="ml-5 space-y-0.5 mt-0.5 border-l border-gray-200 pl-2">
                                  {subpages.map((subpage, idx) => {
                                    const subpageKey = `subpage-${item.id}-${encodeURIComponent(subpage.path)}`;
                                    const isSubpageActive = activeItem === subpageKey;
                                    return (
                                      <button
                                        key={idx}
                                        className={`w-full px-2 py-1 rounded text-left text-xs truncate ${isSubpageActive ? 'bg-primary-100 text-primary-700 font-medium' : 'text-gray-500 hover:bg-gray-50'}`}
                                        onClick={() => setActiveItem(subpageKey)}
                                        title={trimPageTitle(subpage.title)}
                                      >
                                        {trimPageTitle(subpage.title) || getPathEnd(subpage.path)}
                                      </button>
                                    );
                                  })}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                );
              })}
            </nav>
          </div>

          {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
          <div className="flex-1 flex flex-col min-w-0">
            <header className="bg-white border-b border-gray-200 px-5 py-3 flex items-center justify-between flex-shrink-0">
              <div className="text-gray-600 text-sm font-medium">
                evort Analytics
              </div>
              <div className="flex gap-1">
                {dateOptions.map(opt => (
                  <button key={opt.value}
                    className={`px-3 py-1.5 text-xs rounded border ${dateRange === opt.value ? 'bg-primary-600 text-white border-primary-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}
                    onClick={() => setDateRange(opt.value)}>{opt.label}</button>
                ))}
              </div>
            </header>

            <div className="flex-1 p-5 overflow-y-auto">
              <div className="flex items-center justify-between mb-5">
                <div>
                  <h2 className="text-xl font-bold text-gray-800">{getTitle()}</h2>
                  {(activeFilter.type === 'url' || activeFilter.type === 'subpage') && (
                    <p className="text-sm text-gray-500">
                      URL:{' '}
                      <a
                        href={`https://evort.jp${activeFilter.url}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-primary-600 hover:underline"
                      >
                        <code className="bg-gray-100 px-2 py-0.5 rounded">{activeFilter.url}</code>
                        <span className="ml-1">â†—</span>
                      </a>
                    </p>
                  )}
                  {activeFilter.type === 'category' && <p className="text-sm text-gray-500">ã‚«ãƒ†ã‚´ãƒªå†…ã®å…¨URLåˆç®—</p>}
                </div>
              </div>

              {targetUrls.length === 0 ? (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
                  <p className="text-gray-600 mb-2 font-medium">è¨ˆæ¸¬å¯¾è±¡ã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                  <p className="text-sm text-gray-400 mb-4">ã€Œè¨­å®šã‚’ç·¨é›†ã€ã‹ã‚‰URLã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                  <button onClick={onEdit} className="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm hover:bg-primary-700">
                    è¨­å®šã‚’ç·¨é›†
                  </button>
                </div>
              ) : (
                <>
                  <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-5">
                    <p className="text-sm text-blue-700">
                      <span className="font-medium">è¨ˆæ¸¬å¯¾è±¡:</span> {filteredTargetUrls.length}ä»¶ã®URL
                      {activeFilter.type !== 'all' && <span className="text-blue-500">ï¼ˆå…¨ä½“: {targetUrls.length}ä»¶ï¼‰</span>}
                      {excludeUrls.length > 0 && <span className="ml-2 text-blue-500">ï¼ˆé™¤å¤–: {excludeUrls.length}ä»¶ï¼‰</span>}
                    </p>
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
                    <MetricCard title="PVï¼ˆGA4ï¼‰" value={ga4Metrics.pageViews} loading={loading} />
                    <MetricCard title="ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ï¼ˆGA4ï¼‰" value={ga4Metrics.activeUsers} loading={loading} />
                    <MetricCard title="ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ï¼ˆGA4ï¼‰" value={ga4Metrics.sessions} loading={loading} />
                    <MetricCard title="æ¥å ´ä¼æ¥­æ•°ï¼ˆã©ã“ã©ã“JPï¼‰" value={filteredCompanies.length} loading={loading} />
                  </div>

                  <div className="mb-5"><TrendChart data={dailyTrendData} loading={loading} dateRange={dateRange} /></div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                    <RegionDistribution data={regionData} loading={loading} />
                    <DeviceChart data={deviceData} loading={loading} />
                  </div>

                  <div className="mb-5">
                    <h3 className="text-sm font-medium text-gray-700 mb-3">æ¥å ´çµ„ç¹”ï¼ˆã©ã“ã©ã“JPé€£æºï¼‰</h3>
                    <OrganizationList companies={filteredCompanies} loading={loading} />
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ========== App ==========
    function App() {
      const [view, setView] = useState('top'); // 'top', 'create', 'edit', 'dashboard'
      const [projects, setProjects] = useState(() => loadProjects());
      const [currentProject, setCurrentProject] = useState(null);

      // URL routing
      useEffect(() => {
        const handleRoute = () => {
          const path = window.location.pathname;
          if (path === '/' || path === '') {
            setView('top');
            setCurrentProject(null);
          } else {
            const slug = path.replace('/', '');
            const project = projects.find(p => p.slug === slug);
            if (project) {
              setCurrentProject(project);
              setView('dashboard');
            } else {
              setView('top');
            }
          }
        };
        handleRoute();
        window.addEventListener('popstate', handleRoute);
        return () => window.removeEventListener('popstate', handleRoute);
      }, [projects]);

      const navigateTo = (path) => {
        window.history.pushState({}, '', path);
        const event = new PopStateEvent('popstate');
        window.dispatchEvent(event);
      };

      const handleCreateNew = () => {
        setCurrentProject(null);
        setView('create');
      };

      const handleSelectProject = (project) => {
        navigateTo(`/${project.slug}`);
      };

      const handleSaveProject = (projectData) => {
        let updatedProjects;
        if (projects.find(p => p.id === projectData.id)) {
          updatedProjects = projects.map(p => p.id === projectData.id ? projectData : p);
        } else {
          updatedProjects = [...projects, projectData];
        }
        setProjects(updatedProjects);
        saveProjects(updatedProjects);
        setCurrentProject(projectData);
        navigateTo(`/${projectData.slug}`);
      };

      const handleDeleteProject = (projectId) => {
        if (!confirm('ã“ã®ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const updatedProjects = projects.filter(p => p.id !== projectId);
        setProjects(updatedProjects);
        saveProjects(updatedProjects);
      };

      const handleBack = () => {
        navigateTo('/');
      };

      const handleEdit = () => {
        setView('edit');
      };

      const handleCancelEdit = () => {
        if (currentProject) {
          setView('dashboard');
        } else {
          setView('top');
        }
      };

      // ç”»é¢è¡¨ç¤º
      if (view === 'create' || view === 'edit') {
        return (
          <ProjectForm
            project={view === 'edit' ? currentProject : null}
            onSave={handleSaveProject}
            onCancel={handleCancelEdit}
          />
        );
      }

      if (view === 'dashboard' && currentProject) {
        return (
          <AnalyticsDashboard
            project={currentProject}
            onBack={handleBack}
            onEdit={handleEdit}
          />
        );
      }

      return (
        <TopPage
          projects={projects}
          onCreateNew={handleCreateNew}
          onSelectProject={handleSelectProject}
          onDeleteProject={handleDeleteProject}
        />
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
