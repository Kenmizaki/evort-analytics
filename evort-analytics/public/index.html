<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>evort ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ - æ–‰è—¤å…‰å­¦</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f5f3ff',
              100: '#ede9fe',
              200: '#ddd6fe',
              300: '#c4b5fd',
              400: '#a78bfa',
              500: '#8b5cf6',
              600: '#7c3aed',
              700: '#6d28d9',
              800: '#5b21b6',
              900: '#4c1d95',
            }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Noto Sans JP', sans-serif; background: #f8f7fc; }
    .sidebar-fixed { width: 260px; min-width: 260px; }
    @media (max-width: 1024px) {
      .sidebar-fixed { display: none; }
    }
    .loading-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    .live-dot { animation: live-pulse 2s ease-in-out infinite; }
    @keyframes live-pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.2); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ========== API Client ==========
    const API_BASE = '/.netlify/functions/ga4-report';

    async function fetchGA4(params = {}) {
      const queryString = new URLSearchParams(params).toString();
      const url = `${API_BASE}?${queryString}`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error('API fetch error:', error);
        throw error;
      }
    }

    // ========== ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ ==========
    const dummyMetrics = { pv: 1847, pvChange: 12.5, users: 892, usersChange: 8.3, formTransitions: 23, formTransitionsChange: 4, formTransitionRate: 1.24, formTransitionRateChange: 0.15 };
    const dummyDailyData = Array.from({ length: 31 }, (_, i) => ({ date: `12/${i + 1}`, pv: Math.floor(Math.random() * 60) + 30, transitions: Math.floor(Math.random() * 4) }));
    const dummyRegions = [
      { name: 'Tokyo', pv: 423, percent: 22.9 }, { name: 'Osaka', pv: 287, percent: 15.5 }, { name: 'Aichi', pv: 198, percent: 10.7 },
      { name: 'Kanagawa', pv: 156, percent: 8.4 }, { name: 'Fukuoka', pv: 134, percent: 7.3 }, { name: 'Hyogo', pv: 98, percent: 5.3 },
      { name: 'Saitama', pv: 87, percent: 4.7 }, { name: 'Chiba', pv: 76, percent: 4.1 }, { name: 'Shizuoka', pv: 65, percent: 3.5 }, { name: 'Hiroshima', pv: 54, percent: 2.9 }
    ];
    const dummyDevices = [{ name: 'PC', value: 68, color: '#8b5cf6' }, { name: 'Mobile', value: 29, color: '#22c55e' }, { name: 'Tablet', value: 3, color: '#94a3b8' }];

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ 
    const navigation = [
      { id: 'dashboard', label: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', icon: 'ğŸ“Š', children: null },
      { id: 'url-filter', label: 'URLãƒ•ã‚£ãƒ«ã‚¿ãƒ¼', icon: 'ğŸ”—', children: null },
      { id: 'org-filter', label: 'çµ„ç¹”é™¤å¤–è¨­å®š', icon: 'ğŸ¢', children: null },
      { id: 'company', label: 'ä¼æ¥­ã‚³ãƒ³ãƒ†ãƒ³ãƒ„', icon: 'ğŸ“', children: [
        { id: 'presentation', label: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³' }, { id: 'topic1', label: 'USBãƒã‚¤ã‚¯ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—' },
        { id: 'topic2', label: 'HDMIãƒã‚¤ã‚¯ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—' }, { id: 'presenter', label: 'ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¿ãƒ¼' }
      ]},
      { id: 'media', label: 'é›†å®¢ç”¨è¨˜äº‹', icon: 'ğŸ“', children: [
        { id: 'pillar', label: 'å·¥æ¥­ç”¨ãƒã‚¤ã‚¯ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—' }, { id: 'cluster1', label: 'æ¤œæŸ»ç”¨é¡•å¾®é¡' },
        { id: 'cluster2', label: 'é¡•å¾®é¡ å€ç‡' }, { id: 'cluster3', label: 'ãƒã‚¤ã‚¯ãƒ­ã‚¹ã‚³ãƒ¼ãƒ— ä¾¡æ ¼' }
      ]},
      { id: 'form', label: 'ãƒ•ã‚©ãƒ¼ãƒ ', icon: 'ğŸ“', children: [
        { id: 'contact', label: 'å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ' }, { id: 'download', label: 'è³‡æ–™DLãƒ•ã‚©ãƒ¼ãƒ ' }
      ]}
    ];

    // ========== ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ==========

    // æŒ‡æ¨™ã‚«ãƒ¼ãƒ‰
    function MetricCard({ title, value, change, suffix = '', isPercent = false, loading = false }) {
      const isPositive = change >= 0;
      if (loading) return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
          <div className="h-4 w-16 bg-gray-200 rounded loading-pulse mb-2"></div>
          <div className="h-8 w-24 bg-gray-200 rounded loading-pulse"></div>
        </div>
      );
      return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
          <div className="text-gray-500 text-xs mb-1">{title}</div>
          <div className="text-2xl font-bold text-gray-800">
            {typeof value === 'number' ? value.toLocaleString() : value}
            {suffix && <span className="text-base font-normal text-gray-500 ml-1">{suffix}</span>}
          </div>
          <div className={`text-xs mt-2 ${isPositive ? 'text-green-600' : 'text-red-600'}`}>
            {isPositive ? 'â†‘' : 'â†“'} {isPercent ? `${Math.abs(change)}%` : Math.abs(change)} å‰æœˆæ¯”
          </div>
        </div>
      );
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒŠãƒ¼
    function RealtimeBanner({ data, loading }) {
      if (loading) return (
        <div className="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-4 mb-5 text-white">
          <div className="flex items-center gap-2 loading-pulse">
            <div className="w-3 h-3 bg-white rounded-full"></div>
            <span className="text-sm">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èª­ã¿è¾¼ã¿ä¸­...</span>
          </div>
        </div>
      );
      return (
        <div className="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-4 mb-5 text-white">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-3 h-3 bg-white rounded-full live-dot"></div>
              <span className="text-sm font-medium">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </span>
              <span className="text-3xl font-bold">{data?.totalActiveUsers || 0}</span>
              <span className="text-green-100">äººãŒã‚¢ã‚¯ã‚»ã‚¹ä¸­</span>
            </div>
            {data?.companies?.length > 0 && (
              <div className="text-sm text-green-100">
                é–²è¦§ä¸­: {data.companies.slice(0, 3).map(c => c.name).join(', ')}
              </div>
            )}
          </div>
        </div>
      );
    }

    // æ¨ç§»ã‚°ãƒ©ãƒ•
    function TrendChart({ data }) {
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      useEffect(() => {
        if (chartInstance.current) chartInstance.current.destroy();
        const ctx = chartRef.current.getContext('2d');
        const pvGradient = ctx.createLinearGradient(0, 0, 0, 220);
        pvGradient.addColorStop(0, 'rgba(99, 102, 241, 0.9)');
        pvGradient.addColorStop(0.5, 'rgba(59, 130, 246, 0.7)');
        pvGradient.addColorStop(1, 'rgba(34, 197, 94, 0.6)');

        chartInstance.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => d.date),
            datasets: [{
              label: 'PV', data: data.map(d => d.pv), fill: true, backgroundColor: pvGradient,
              borderColor: 'rgba(99, 102, 241, 0.8)', borderWidth: 2, tension: 0.4, pointRadius: 0,
              pointHoverRadius: 6, pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgba(99, 102, 241, 1)',
              pointHoverBorderWidth: 2, yAxisID: 'y', order: 2
            }, {
              label: 'ãƒ•ã‚©ãƒ¼ãƒ é·ç§»æ•°', data: data.map(d => d.transitions), fill: false, borderColor: '#f97316',
              backgroundColor: '#f97316', borderWidth: 2, tension: 0.3, pointRadius: 3, pointBackgroundColor: '#fff',
              pointBorderColor: '#f97316', pointBorderWidth: 2, pointHoverRadius: 6, yAxisID: 'y1', order: 1
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
            scales: {
              y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'PV', font: { size: 10 }, color: '#94a3b8' }, grid: { color: '#f1f5f9' }, ticks: { color: '#94a3b8', font: { size: 9 } }, beginAtZero: true },
              y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'ãƒ•ã‚©ãƒ¼ãƒ é·ç§»æ•°', font: { size: 10 }, color: '#94a3b8' }, grid: { drawOnChartArea: false }, min: 0, max: 6, ticks: { color: '#94a3b8', font: { size: 9 } } },
              x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 8 }, maxRotation: 0 } }
            },
            plugins: {
              legend: { position: 'top', labels: { font: { size: 11 }, usePointStyle: true, padding: 15 } },
              tooltip: { backgroundColor: 'rgba(255, 255, 255, 0.95)', titleColor: '#374151', bodyColor: '#374151', borderColor: '#e5e7eb', borderWidth: 1, cornerRadius: 8, padding: 12 }
            }
          }
        });
        return () => { if (chartInstance.current) chartInstance.current.destroy(); };
      }, [data]);

      return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
          <h3 className="text-sm font-medium text-gray-700 mb-4">æ¨ç§»</h3>
          <div style={{ height: '220px' }}><canvas ref={chartRef}></canvas></div>
        </div>
      );
    }

    // åœ°åŸŸåˆ†å¸ƒ
    function RegionDistribution({ data, loading }) {
      if (loading) return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100 h-full">
          <h3 className="text-sm font-medium text-gray-700 mb-4">åœ°åŸŸåˆ†å¸ƒï¼ˆä¸Šä½10ï¼‰</h3>
          <div className="space-y-2">{Array(10).fill(0).map((_, i) => <div key={i} className="h-4 bg-gray-200 rounded loading-pulse"></div>)}</div>
        </div>
      );
      return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100 h-full">
          <h3 className="text-sm font-medium text-gray-700 mb-4">åœ°åŸŸåˆ†å¸ƒï¼ˆä¸Šä½10ï¼‰</h3>
          <div className="space-y-2">
            {data.map((region, index) => (
              <div key={region.name} className="flex items-center justify-between text-xs">
                <div className="flex items-center"><span className="text-gray-400 w-5">{index + 1}.</span><span className="text-gray-700">{region.name}</span></div>
                <div className="flex items-center gap-3"><span className="text-gray-600">{region.pv}</span><span className="text-gray-400 w-10 text-right">{region.percent}%</span></div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ãƒ‡ãƒã‚¤ã‚¹ãƒãƒ£ãƒ¼ãƒˆ
    function DeviceChart({ data }) {
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      useEffect(() => {
        if (chartInstance.current) chartInstance.current.destroy();
        const ctx = chartRef.current.getContext('2d');
        chartInstance.current = new Chart(ctx, {
          type: 'doughnut',
          data: { labels: data.map(d => d.name), datasets: [{ data: data.map(d => d.value), backgroundColor: data.map(d => d.color), borderWidth: 0 }] },
          options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false } } }
        });
        return () => { if (chartInstance.current) chartInstance.current.destroy(); };
      }, [data]);

      return (
        <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100 h-full">
          <h3 className="text-sm font-medium text-gray-700 mb-4">ãƒ‡ãƒã‚¤ã‚¹</h3>
          <div className="flex items-center gap-6">
            <div style={{ width: '100px', height: '100px' }}><canvas ref={chartRef}></canvas></div>
            <div className="flex-1 space-y-2">
              {data.map((item, i) => (
                <div key={i} className="flex items-center justify-between text-xs">
                  <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{ backgroundColor: item.color }}></div><span className="text-gray-700">{item.name}</span></div>
                  <span className="text-gray-600 font-medium">{item.value}%</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // æ¥å ´çµ„ç¹”ãƒªã‚¹ãƒˆï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿å¯¾å¿œ + ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½å¼·åŒ–ï¼‰
    function OrganizationList({ companies, loading, onFilterChange, apiFilters = {} }) {
      const [sortConfig, setSortConfig] = useState({ key: 'sessions', direction: 'desc' });
      const [searchTerm, setSearchTerm] = useState('');
      const [industryFilter, setIndustryFilter] = useState('');
      const [prefectureFilter, setPrefectureFilter] = useState('');
      const [employeesFilter, setEmployeesFilter] = useState('');
      const [urlFilter, setUrlFilter] = useState('');
      const [showFilters, setShowFilters] = useState(false);

      const handleSort = (key) => {
        setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc' }));
      };

      const getSortIcon = (key) => {
        if (sortConfig.key !== key) return 'â†•';
        return sortConfig.direction === 'asc' ? 'â†‘' : 'â†“';
      };

      // APIãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
      const applyApiFilters = () => {
        if (onFilterChange) {
          onFilterChange({
            url: urlFilter || null,
            prefecture: prefectureFilter || null,
            industry: industryFilter || null,
            employees: employeesFilter || null,
          });
        }
      };

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
      const clearFilters = () => {
        setSearchTerm('');
        setIndustryFilter('');
        setPrefectureFilter('');
        setEmployeesFilter('');
        setUrlFilter('');
        if (onFilterChange) {
          onFilterChange({});
        }
      };

      const sortedData = [...companies].sort((a, b) => {
        const aVal = a[sortConfig.key];
        const bVal = b[sortConfig.key];
        const modifier = sortConfig.direction === 'asc' ? 1 : -1;
        if (typeof aVal === 'number') return (aVal - bVal) * modifier;
        return String(aVal || '').localeCompare(String(bVal || '')) * modifier;
      }).filter(c => {
        const matchSearch = !searchTerm || c.name?.toLowerCase().includes(searchTerm.toLowerCase());
        return matchSearch;
      });

      const industries = [...new Set(companies.map(c => c.industry).filter(Boolean))].sort();
      const prefectures = [...new Set(companies.map(c => c.prefecture).filter(Boolean))].sort();
      const employeeRanges = [...new Set(companies.map(c => c.employees).filter(Boolean))].sort();

      const columns = [
        { key: 'name', label: 'çµ„ç¹”å' }, { key: 'prefecture', label: 'éƒ½é“åºœçœŒ' }, { key: 'employees', label: 'å¾“æ¥­å“¡æ•°' },
        { key: 'industry', label: 'æ¥­ç¨®' }, { key: 'sessions', label: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³' }, { key: 'pageViews', label: 'PV' }
      ];

      const hasActiveFilters = urlFilter || prefectureFilter || industryFilter || employeesFilter;

      if (loading) return (
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-10">
          <div className="text-center text-gray-400 loading-pulse">ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      );

      return (
        <div className="bg-white rounded-xl shadow-sm border border-gray-100">
          {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
          <div className="p-4 border-b border-gray-100">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-3">
                <input type="text" placeholder="ä¼æ¥­åã§æ¤œç´¢..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                  className="px-3 py-1.5 text-xs border rounded-lg w-48 focus:ring-2 focus:ring-primary-500 focus:border-primary-500" />
                <button onClick={() => setShowFilters(!showFilters)}
                  className={`px-3 py-1.5 text-xs rounded-lg border flex items-center gap-1 ${showFilters || hasActiveFilters ? 'bg-primary-50 border-primary-300 text-primary-700' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`}>
                  <span>ğŸ”</span> è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ {hasActiveFilters && <span className="bg-primary-600 text-white rounded-full w-4 h-4 text-[10px] flex items-center justify-center">!</span>}
                </button>
              </div>
              <div className="text-xs text-gray-500">{sortedData.length} ä»¶ã®ä¼æ¥­</div>
            </div>

            {/* è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå±•é–‹æ™‚ï¼‰ */}
            {showFilters && (
              <div className="bg-gray-50 rounded-lg p-4 mt-3">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                  {/* URLãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">ğŸ“„ é–²è¦§ãƒšãƒ¼ã‚¸URL</label>
                    <input type="text" placeholder="/product/microscope..." value={urlFilter} onChange={e => setUrlFilter(e.target.value)}
                      className="w-full px-3 py-1.5 text-xs border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" />
                    <p className="text-[10px] text-gray-400 mt-1">éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢</p>
                  </div>

                  {/* éƒ½é“åºœçœŒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">ğŸ“ éƒ½é“åºœçœŒ</label>
                    <select value={prefectureFilter} onChange={e => setPrefectureFilter(e.target.value)}
                      className="w-full px-3 py-1.5 text-xs border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                      <option value="">ã™ã¹ã¦ã®åœ°åŸŸ</option>
                      {prefectures.map(pref => <option key={pref} value={pref}>{pref}</option>)}
                    </select>
                  </div>

                  {/* æ¥­ç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">ğŸ­ æ¥­ç¨®</label>
                    <select value={industryFilter} onChange={e => setIndustryFilter(e.target.value)}
                      className="w-full px-3 py-1.5 text-xs border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                      <option value="">ã™ã¹ã¦ã®æ¥­ç¨®</option>
                      {industries.map(ind => <option key={ind} value={ind}>{ind}</option>)}
                    </select>
                  </div>

                  {/* å¾“æ¥­å“¡æ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">ğŸ‘¥ å¾“æ¥­å“¡æ•°</label>
                    <select value={employeesFilter} onChange={e => setEmployeesFilter(e.target.value)}
                      className="w-full px-3 py-1.5 text-xs border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                      <option value="">ã™ã¹ã¦ã®è¦æ¨¡</option>
                      {employeeRanges.map(emp => <option key={emp} value={emp}>{emp}</option>)}
                    </select>
                  </div>
                </div>

                {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */}
                <div className="flex items-center justify-end gap-2 mt-4 pt-3 border-t border-gray-200">
                  <button onClick={clearFilters}
                    className="px-3 py-1.5 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-100">
                    ã‚¯ãƒªã‚¢
                  </button>
                  <button onClick={applyApiFilters}
                    className="px-4 py-1.5 text-xs rounded-lg bg-primary-600 text-white hover:bg-primary-700 font-medium">
                    ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                  </button>
                </div>
              </div>
            )}

            {/* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤º */}
            {hasActiveFilters && !showFilters && (
              <div className="flex items-center gap-2 mt-2 flex-wrap">
                <span className="text-xs text-gray-500">é©ç”¨ä¸­:</span>
                {urlFilter && <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">URL: {urlFilter}</span>}
                {prefectureFilter && <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">{prefectureFilter}</span>}
                {industryFilter && <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">{industryFilter}</span>}
                {employeesFilter && <span className="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs">{employeesFilter}</span>}
                <button onClick={clearFilters} className="text-xs text-red-600 hover:text-red-700 ml-2">âœ• ã‚¯ãƒªã‚¢</button>
              </div>
            )}
          </div>

          {/* ãƒ†ãƒ¼ãƒ–ãƒ« */}
          <div className="overflow-x-auto">
            <table className="w-full text-xs">
              <thead>
                <tr className="bg-primary-600 text-white">
                  {columns.map(col => (
                    <th key={col.key} className="px-3 py-2 text-left font-medium cursor-pointer hover:bg-primary-700 whitespace-nowrap" onClick={() => handleSort(col.key)}>
                      {col.label} <span className="text-primary-300 ml-1">{getSortIcon(col.key)}</span>
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {sortedData.length === 0 ? (
                  <tr><td colSpan={columns.length} className="px-3 py-8 text-center text-gray-400">è©²å½“ã™ã‚‹ä¼æ¥­ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
                ) : sortedData.slice(0, 50).map((row, index) => (
                  <tr key={index} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-primary-50 cursor-pointer`}>
                    <td className="px-3 py-1.5 text-gray-700 whitespace-nowrap font-medium">{row.name || 'ä¸æ˜'}</td>
                    <td className="px-3 py-1.5 text-gray-700 whitespace-nowrap">{row.prefecture || '-'}</td>
                    <td className="px-3 py-1.5 text-gray-700 whitespace-nowrap">{row.employees || '-'}</td>
                    <td className="px-3 py-1.5 text-gray-700 whitespace-nowrap">{row.industry || '-'}</td>
                    <td className="px-3 py-1.5 text-gray-700 whitespace-nowrap text-right font-medium">{row.sessions?.toLocaleString() || 0}</td>
                    <td className="px-3 py-1.5 text-gray-700 whitespace-nowrap text-right">{row.pageViews?.toLocaleString() || 0}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          {sortedData.length > 50 && (
            <div className="p-3 text-center text-xs text-gray-500 border-t border-gray-100">
              ä¸Šä½50ä»¶ã‚’è¡¨ç¤ºä¸­ï¼ˆå…¨{sortedData.length}ä»¶ï¼‰
            </div>
          )}
        </div>
      );
    }

    // URLãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šãƒšãƒ¼ã‚¸
    function UrlFilterPage({ urlFilters, setUrlFilters }) {
      const [newUrl, setNewUrl] = useState('');
      const [matchType, setMatchType] = useState('prefix'); // 'exact' or 'prefix'
      const [filterType, setFilterType] = useState('include'); // 'include' or 'exclude'

      const addFilter = () => {
        if (!newUrl.trim()) return;
        const newFilter = {
          id: Date.now(),
          url: newUrl.trim(),
          matchType,
          filterType,
        };
        setUrlFilters([...urlFilters, newFilter]);
        setNewUrl('');
      };

      const removeFilter = (id) => {
        setUrlFilters(urlFilters.filter(f => f.id !== id));
      };

      const includeFilters = urlFilters.filter(f => f.filterType === 'include');
      const excludeFilters = urlFilters.filter(f => f.filterType === 'exclude');

      return (
        <div className="p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-2">URLãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š</h2>
          <p className="text-sm text-gray-500 mb-6">ç‰¹å®šã®URLã‚’é–²è¦§ã—ãŸä¼æ¥­ã®ã¿ã‚’è¡¨ç¤ºã€ã¾ãŸã¯é™¤å¤–ã—ã¾ã™</p>

          {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
            <h3 className="text-sm font-medium text-gray-700 mb-4">æ–°ã—ã„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¿½åŠ </h3>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div className="md:col-span-2">
                <label className="block text-xs font-medium text-gray-600 mb-1">URL ãƒ‘ã‚¹</label>
                <input type="text" value={newUrl} onChange={e => setNewUrl(e.target.value)}
                  placeholder="/products/microscope"
                  className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-600 mb-1">ãƒãƒƒãƒã‚¿ã‚¤ãƒ—</label>
                <select value={matchType} onChange={e => setMatchType(e.target.value)}
                  className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                  <option value="prefix">å‰æ–¹ä¸€è‡´ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹å…¨éƒ¨ï¼‰</option>
                  <option value="exact">å®Œå…¨ä¸€è‡´</option>
                </select>
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-600 mb-1">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—</label>
                <select value={filterType} onChange={e => setFilterType(e.target.value)}
                  className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                  <option value="include">å«ã‚ã‚‹ï¼ˆã“ã®URLã‚’è¦‹ãŸä¼æ¥­ï¼‰</option>
                  <option value="exclude">é™¤å¤–ã™ã‚‹</option>
                </select>
              </div>
            </div>
            <div className="mt-4">
              <button onClick={addFilter}
                className="px-4 py-2 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700 font-medium">
                + ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¿½åŠ 
              </button>
            </div>
          </div>

          {/* å«ã‚ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-4">
            <h3 className="text-sm font-medium text-green-700 mb-3 flex items-center gap-2">
              <span className="w-2 h-2 bg-green-500 rounded-full"></span>
              å«ã‚ã‚‹URLï¼ˆã“ã®URLã‚’é–²è¦§ã—ãŸä¼æ¥­ã‚’è¡¨ç¤ºï¼‰
            </h3>
            {includeFilters.length === 0 ? (
              <p className="text-sm text-gray-400">è¨­å®šãªã—ï¼ˆã™ã¹ã¦ã®URLã‚’å¯¾è±¡ï¼‰</p>
            ) : (
              <div className="space-y-2">
                {includeFilters.map(filter => (
                  <div key={filter.id} className="flex items-center justify-between bg-green-50 px-3 py-2 rounded-lg">
                    <div className="flex items-center gap-3">
                      <code className="text-sm text-green-800 bg-green-100 px-2 py-0.5 rounded">{filter.url}</code>
                      <span className="text-xs text-green-600">
                        {filter.matchType === 'exact' ? 'å®Œå…¨ä¸€è‡´' : 'å‰æ–¹ä¸€è‡´'}
                      </span>
                    </div>
                    <button onClick={() => removeFilter(filter.id)} className="text-red-500 hover:text-red-700 text-sm">âœ•</button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <h3 className="text-sm font-medium text-red-700 mb-3 flex items-center gap-2">
              <span className="w-2 h-2 bg-red-500 rounded-full"></span>
              é™¤å¤–ã™ã‚‹URL
            </h3>
            {excludeFilters.length === 0 ? (
              <p className="text-sm text-gray-400">è¨­å®šãªã—</p>
            ) : (
              <div className="space-y-2">
                {excludeFilters.map(filter => (
                  <div key={filter.id} className="flex items-center justify-between bg-red-50 px-3 py-2 rounded-lg">
                    <div className="flex items-center gap-3">
                      <code className="text-sm text-red-800 bg-red-100 px-2 py-0.5 rounded">{filter.url}</code>
                      <span className="text-xs text-red-600">
                        {filter.matchType === 'exact' ? 'å®Œå…¨ä¸€è‡´' : 'å‰æ–¹ä¸€è‡´'}
                      </span>
                    </div>
                    <button onClick={() => removeFilter(filter.id)} className="text-red-500 hover:text-red-700 text-sm">âœ•</button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* é©ç”¨çŠ¶æ³ */}
          <div className="mt-6 p-4 bg-blue-50 rounded-lg">
            <p className="text-sm text-blue-800">
              <strong>ç¾åœ¨ã®è¨­å®šï¼š</strong>
              {includeFilters.length > 0 ? ` ${includeFilters.length}ä»¶ã®URLã‚’å«ã‚ã‚‹` : ' ã™ã¹ã¦ã®URL'}
              {excludeFilters.length > 0 ? ` / ${excludeFilters.length}ä»¶ã‚’é™¤å¤–` : ''}
            </p>
          </div>
        </div>
      );
    }

    // çµ„ç¹”é™¤å¤–è¨­å®šãƒšãƒ¼ã‚¸
    function OrgFilterPage({ orgExclusions, setOrgExclusions, companies }) {
      const [exclusionType, setExclusionType] = useState('name'); // 'name', 'industry', 'prefecture', 'employees'
      const [exclusionValue, setExclusionValue] = useState('');

      const addExclusion = () => {
        if (!exclusionValue.trim()) return;
        const newExclusion = {
          id: Date.now(),
          type: exclusionType,
          value: exclusionValue.trim(),
        };
        setOrgExclusions([...orgExclusions, newExclusion]);
        setExclusionValue('');
      };

      const removeExclusion = (id) => {
        setOrgExclusions(orgExclusions.filter(e => e.id !== id));
      };

      const typeLabels = {
        name: 'çµ„ç¹”å',
        industry: 'æ¥­ç¨®',
        prefecture: 'éƒ½é“åºœçœŒ',
        employees: 'å¾“æ¥­å“¡æ•°',
      };

      // é¸æŠè‚¢ã®å–å¾—
      const getOptions = () => {
        switch (exclusionType) {
          case 'name':
            return [...new Set(companies.map(c => c.name).filter(Boolean))].sort();
          case 'industry':
            return [...new Set(companies.map(c => c.industry).filter(Boolean))].sort();
          case 'prefecture':
            return [...new Set(companies.map(c => c.prefecture).filter(Boolean))].sort();
          case 'employees':
            return [...new Set(companies.map(c => c.employees).filter(Boolean))].sort();
          default:
            return [];
        }
      };

      const groupedExclusions = {
        name: orgExclusions.filter(e => e.type === 'name'),
        industry: orgExclusions.filter(e => e.type === 'industry'),
        prefecture: orgExclusions.filter(e => e.type === 'prefecture'),
        employees: orgExclusions.filter(e => e.type === 'employees'),
      };

      return (
        <div className="p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-2">çµ„ç¹”é™¤å¤–è¨­å®š</h2>
          <p className="text-sm text-gray-500 mb-6">ç‰¹å®šã®çµ„ç¹”ã‚„æ¡ä»¶ã«è©²å½“ã™ã‚‹ä¼æ¥­ã‚’è¡¨ç¤ºã‹ã‚‰é™¤å¤–ã—ã¾ã™</p>

          {/* é™¤å¤–æ¡ä»¶è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
            <h3 className="text-sm font-medium text-gray-700 mb-4">æ–°ã—ã„é™¤å¤–æ¡ä»¶ã‚’è¿½åŠ </h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="block text-xs font-medium text-gray-600 mb-1">é™¤å¤–æ¡ä»¶ã‚¿ã‚¤ãƒ—</label>
                <select value={exclusionType} onChange={e => { setExclusionType(e.target.value); setExclusionValue(''); }}
                  className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                  <option value="name">çµ„ç¹”å</option>
                  <option value="industry">æ¥­ç¨®</option>
                  <option value="prefecture">éƒ½é“åºœçœŒ</option>
                  <option value="employees">å¾“æ¥­å“¡æ•°</option>
                </select>
              </div>
              <div className="md:col-span-2">
                <label className="block text-xs font-medium text-gray-600 mb-1">é™¤å¤–ã™ã‚‹å€¤</label>
                {exclusionType === 'name' ? (
                  <input type="text" value={exclusionValue} onChange={e => setExclusionValue(e.target.value)}
                    placeholder="çµ„ç¹”åã‚’å…¥åŠ›..." list="org-names"
                    className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" />
                ) : (
                  <select value={exclusionValue} onChange={e => setExclusionValue(e.target.value)}
                    className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    {getOptions().map(opt => <option key={opt} value={opt}>{opt}</option>)}
                  </select>
                )}
                <datalist id="org-names">
                  {getOptions().slice(0, 100).map(opt => <option key={opt} value={opt} />)}
                </datalist>
              </div>
            </div>
            <div className="mt-4">
              <button onClick={addExclusion}
                className="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 font-medium">
                + é™¤å¤–æ¡ä»¶ã‚’è¿½åŠ 
              </button>
            </div>
          </div>

          {/* é™¤å¤–æ¡ä»¶ä¸€è¦§ */}
          {Object.entries(groupedExclusions).map(([type, exclusions]) => (
            exclusions.length > 0 && (
              <div key={type} className="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-4">
                <h3 className="text-sm font-medium text-red-700 mb-3 flex items-center gap-2">
                  <span className="w-2 h-2 bg-red-500 rounded-full"></span>
                  {typeLabels[type]}ã§é™¤å¤–
                </h3>
                <div className="flex flex-wrap gap-2">
                  {exclusions.map(exc => (
                    <span key={exc.id} className="inline-flex items-center gap-1 bg-red-50 text-red-800 px-3 py-1 rounded-full text-sm">
                      {exc.value}
                      <button onClick={() => removeExclusion(exc.id)} className="text-red-500 hover:text-red-700 ml-1">âœ•</button>
                    </span>
                  ))}
                </div>
              </div>
            )
          ))}

          {orgExclusions.length === 0 && (
            <div className="bg-gray-50 rounded-xl p-8 text-center">
              <p className="text-gray-400">é™¤å¤–æ¡ä»¶ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            </div>
          )}

          {/* é©ç”¨çŠ¶æ³ */}
          {orgExclusions.length > 0 && (
            <div className="mt-6 p-4 bg-red-50 rounded-lg">
              <p className="text-sm text-red-800">
                <strong>ç¾åœ¨ã®é™¤å¤–è¨­å®šï¼š</strong> {orgExclusions.length}ä»¶ã®æ¡ä»¶ã§é™¤å¤–ä¸­
              </p>
            </div>
          )}
        </div>
      );
    }

    // å·¦ã‚«ãƒ©ãƒ ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰
    function Sidebar({ activeItem, onSelectItem }) {
      const [expandedItems, setExpandedItems] = useState(['company', 'media', 'form']);
      const toggleExpand = (id) => setExpandedItems(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);

      return (
        <div className="sidebar-fixed bg-white border-r border-gray-200 h-screen overflow-y-auto flex-shrink-0">
          <div className="p-4 border-b border-gray-100">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-primary-600 rounded-lg flex items-center justify-center"><span className="text-white font-bold">S</span></div>
              <div><h1 className="text-sm font-bold text-gray-800">æ–‰è—¤å…‰å­¦æ ªå¼ä¼šç¤¾</h1><p className="text-xs text-gray-500">ãƒã‚¤ã‚¯ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—</p></div>
            </div>
          </div>
          <nav className="p-3">
            {navigation.map(item => (
              <div key={item.id} className="mb-1">
                <button className={`w-full flex items-center px-3 py-2 rounded-lg text-left text-sm ${activeItem === item.id ? 'bg-primary-50 text-primary-600' : 'text-gray-700 hover:bg-gray-50'}`}
                  onClick={() => { if (item.children) toggleExpand(item.id); onSelectItem(item.id); }}>
                  <span className="mr-2">{item.icon}</span><span className="flex-1 font-medium">{item.label}</span>
                  {item.children && <span className="text-gray-400 text-xs">{expandedItems.includes(item.id) ? 'â–¼' : 'â–¶'}</span>}
                </button>
                {item.children && expandedItems.includes(item.id) && (
                  <div className="ml-7 mt-1 space-y-1">
                    {item.children.map(child => (
                      <button key={child.id} className={`w-full px-3 py-1.5 rounded text-left text-xs ${activeItem === child.id ? 'bg-primary-50 text-primary-600 font-medium' : 'text-gray-600 hover:bg-gray-50'}`}
                        onClick={() => onSelectItem(child.id)}>{child.label}</button>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </nav>
        </div>
      );
    }

    // æœŸé–“é¸æŠ
    function DateRangePicker({ dateRange, onDateRangeChange }) {
      const quickOptions = [
        { label: '7æ—¥', value: '7daysAgo' }, { label: '30æ—¥', value: '30daysAgo' },
        { label: '90æ—¥', value: '90daysAgo' }, { label: '12ãƒ¶æœˆ', value: '365daysAgo' }
      ];

      return (
        <div className="flex items-center gap-2">
          <div className="flex gap-1">
            {quickOptions.map(opt => (
              <button key={opt.value}
                className={`px-3 py-1.5 text-xs rounded shadow-sm border ${dateRange === opt.value ? 'bg-primary-600 text-white border-primary-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}
                onClick={() => onDateRangeChange(opt.value)}>{opt.label}</button>
            ))}
          </div>
        </div>
      );
    }

    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰
    function DashboardContent({ dateRange, urlFilters, orgExclusions, allCompanies, setAllCompanies }) {
      const [metrics, setMetrics] = useState(null);
      const [realtime, setRealtime] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      const loadData = useCallback(async () => {
        setLoading(true);
        setError(null);
        try {
          // URLãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰APIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
          const includeUrls = urlFilters.filter(f => f.filterType === 'include');
          const apiParams = { type: 'companies', startDate: dateRange, endDate: 'today' };

          // å«ã‚ã‚‹URLãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒã‚ã‚‹å ´åˆã€æœ€åˆã®1ã¤ã‚’APIã«é€ä¿¡ï¼ˆè¤‡æ•°ã¯å¾Œã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
          if (includeUrls.length > 0) {
            apiParams.url = includeUrls[0].url;
          }

          const [overviewRes, companiesRes, realtimeRes] = await Promise.all([
            fetchGA4({ type: 'overview', startDate: dateRange, endDate: 'today' }),
            fetchGA4(apiParams),
            fetchGA4({ type: 'realtime' })
          ]);
          setMetrics(overviewRes.data);
          setAllCompanies(companiesRes.data || []);
          setRealtime(realtimeRes.data);
        } catch (err) {
          console.error('Data load error:', err);
          setError('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚');
          setMetrics(dummyMetrics);
          setAllCompanies([]);
        } finally {
          setLoading(false);
        }
      }, [dateRange, urlFilters, setAllCompanies]);

      useEffect(() => { loadData(); }, [loadData]);

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
      useEffect(() => {
        const interval = setInterval(async () => {
          try {
            const res = await fetchGA4({ type: 'realtime' });
            setRealtime(res.data);
          } catch (err) { /* ignore */ }
        }, 30000);
        return () => clearInterval(interval);
      }, []);

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œã®ä¼æ¥­ãƒ‡ãƒ¼ã‚¿
      const filteredCompanies = allCompanies.filter(company => {
        // çµ„ç¹”é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        for (const exc of orgExclusions) {
          if (exc.type === 'name' && company.name === exc.value) return false;
          if (exc.type === 'industry' && company.industry === exc.value) return false;
          if (exc.type === 'prefecture' && company.prefecture === exc.value) return false;
          if (exc.type === 'employees' && company.employees === exc.value) return false;
        }
        return true;
      });

      // åœ°åŸŸãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
      const regionData = filteredCompanies.reduce((acc, c) => {
        if (c.prefecture) acc[c.prefecture] = (acc[c.prefecture] || 0) + c.sessions;
        return acc;
      }, {});
      const totalSessions = Object.values(regionData).reduce((a, b) => a + b, 0) || 1;
      const regions = Object.entries(regionData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([name, pv]) => ({ name, pv, percent: ((pv / totalSessions) * 100).toFixed(1) }));

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ³ã‚µãƒãƒªãƒ¼
      const hasFilters = urlFilters.length > 0 || orgExclusions.length > 0;

      return (
        <div className="flex-1 p-5 overflow-y-auto">
          <div className="flex items-center justify-between mb-5">
            <h2 className="text-xl font-bold text-gray-800">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            {error && <div className="text-xs text-orange-600 bg-orange-50 px-3 py-1 rounded">{error}</div>}
          </div>

          {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­ãƒãƒŠãƒ¼ */}
          {hasFilters && (
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 flex items-center justify-between">
              <div className="flex items-center gap-4 text-sm">
                <span className="text-blue-700 font-medium">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­</span>
                {urlFilters.length > 0 && (
                  <span className="text-blue-600">URL: {urlFilters.length}ä»¶</span>
                )}
                {orgExclusions.length > 0 && (
                  <span className="text-blue-600">é™¤å¤–: {orgExclusions.length}ä»¶</span>
                )}
              </div>
              <span className="text-xs text-blue-600">
                {filteredCompanies.length} / {allCompanies.length} ä»¶è¡¨ç¤º
              </span>
            </div>
          )}

          {/* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒŠãƒ¼ */}
          <RealtimeBanner data={realtime} loading={loading} />

          {/* ä¸»è¦æŒ‡æ¨™ã‚«ãƒ¼ãƒ‰ */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
            <MetricCard title="PV" value={metrics?.pageViews || 0} change={12.5} isPercent={true} loading={loading} />
            <MetricCard title="ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°" value={metrics?.activeUsers || 0} change={8.3} isPercent={true} loading={loading} />
            <MetricCard title="ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°" value={metrics?.sessions || 0} change={10.2} isPercent={true} loading={loading} />
            <MetricCard title="å¹³å‡æ»åœ¨æ™‚é–“" value={metrics?.avgSessionDuration ? Math.floor(metrics.avgSessionDuration / 60) + 'åˆ†' + Math.floor(metrics.avgSessionDuration % 60) + 'ç§’' : '-'} change={5.1} isPercent={true} loading={loading} />
          </div>

          {/* æ¨ç§»ã‚°ãƒ©ãƒ• */}
          <div className="mb-5"><TrendChart data={dummyDailyData} /></div>

          {/* åœ°åŸŸåˆ†å¸ƒ + ãƒ‡ãƒã‚¤ã‚¹ */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
            <RegionDistribution data={regions.length > 0 ? regions : dummyRegions} loading={loading} />
            <DeviceChart data={dummyDevices} />
          </div>

          {/* æ¥å ´çµ„ç¹”ãƒªã‚¹ãƒˆ */}
          <div className="mb-5">
            <h3 className="text-sm font-medium text-gray-700 mb-3">æ¥å ´çµ„ç¹”ï¼ˆã©ã“ã©ã“JPé€£æºï¼‰</h3>
            <OrganizationList companies={filteredCompanies} loading={loading} />
          </div>
        </div>
      );
    }

    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ«ãƒ¼ã‚¿ãƒ¼
    function MainContent({ activeItem, dateRange, urlFilters, setUrlFilters, orgExclusions, setOrgExclusions }) {
      const [allCompanies, setAllCompanies] = useState([]);

      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸
      if (activeItem === 'dashboard') {
        return (
          <DashboardContent
            dateRange={dateRange}
            urlFilters={urlFilters}
            orgExclusions={orgExclusions}
            allCompanies={allCompanies}
            setAllCompanies={setAllCompanies}
          />
        );
      }

      // URLãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šãƒšãƒ¼ã‚¸
      if (activeItem === 'url-filter') {
        return <UrlFilterPage urlFilters={urlFilters} setUrlFilters={setUrlFilters} />;
      }

      // çµ„ç¹”é™¤å¤–è¨­å®šãƒšãƒ¼ã‚¸
      if (activeItem === 'org-filter') {
        return <OrgFilterPage orgExclusions={orgExclusions} setOrgExclusions={setOrgExclusions} companies={allCompanies} />;
      }

      // ãã®ä»–ã®ãƒšãƒ¼ã‚¸ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
      const getTitle = () => {
        for (const nav of navigation) {
          if (nav.id === activeItem) return nav.label;
          if (nav.children) {
            const child = nav.children.find(c => c.id === activeItem);
            if (child) return child.label;
          }
        }
        return '';
      };

      return (
        <div className="flex-1 p-5 overflow-y-auto">
          <div className="flex items-center justify-between mb-5">
            <h2 className="text-xl font-bold text-gray-800">{getTitle()}</h2>
          </div>
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-10 text-center">
            <p className="text-gray-400">ã“ã®ãƒšãƒ¼ã‚¸ã¯ã¾ã æº–å‚™ä¸­ã§ã™</p>
          </div>
        </div>
      );
    }

    // App
    function App() {
      const [activeItem, setActiveItem] = useState('dashboard');
      const [dateRange, setDateRange] = useState('30daysAgo');

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜å¯èƒ½ï¼‰
      const [urlFilters, setUrlFilters] = useState([]);
      const [orgExclusions, setOrgExclusions] = useState([]);

      return (
        <div className="flex min-h-screen">
          <Sidebar activeItem={activeItem} onSelectItem={setActiveItem} />
          <div className="flex-1 flex flex-col min-w-0">
            <header className="bg-white border-b border-gray-200 px-5 py-3 flex items-center justify-between flex-shrink-0">
              <div className="text-gray-600 text-sm font-medium">
                evort ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹
                <span className="text-xs text-green-600 ml-2">â— LIVE</span>
                {(urlFilters.length > 0 || orgExclusions.length > 0) && (
                  <span className="text-xs text-blue-600 ml-2 bg-blue-50 px-2 py-0.5 rounded">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­</span>
                )}
              </div>
              <DateRangePicker dateRange={dateRange} onDateRangeChange={setDateRange} />
            </header>
            <MainContent
              activeItem={activeItem}
              dateRange={dateRange}
              urlFilters={urlFilters}
              setUrlFilters={setUrlFilters}
              orgExclusions={orgExclusions}
              setOrgExclusions={setOrgExclusions}
            />
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
